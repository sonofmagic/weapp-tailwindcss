<!doctype html>
<html lang="zh-cn" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-principle/index" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">tailwindcss in weapp 的原理 | weapp-tw 把tailwindcss带给小程序开发者们</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://weapp-tw.icebreaker.top/weapp-tailwindcss/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://weapp-tw.icebreaker.top/weapp-tailwindcss/img/logo.png"><meta data-rh="true" property="og:url" content="https://weapp-tw.icebreaker.top/weapp-tailwindcss/docs/principle"><meta data-rh="true" property="og:locale" content="zh_cn"><meta data-rh="true" name="docusaurus_locale" content="zh-cn"><meta data-rh="true" name="docsearch:language" content="zh-cn"><meta data-rh="true" name="keywords" content="weapp,小程序,tailwindcss,原子类,uni-app,taro,rax,mpx,native,remax,原生,webpack,plugin,vite,gulp,wxss,wxml"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="tailwindcss in weapp 的原理 | weapp-tw 把tailwindcss带给小程序开发者们"><meta data-rh="true" name="description" content="2024-02-20 版本"><meta data-rh="true" property="og:description" content="2024-02-20 版本"><link data-rh="true" rel="icon" href="/weapp-tailwindcss/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://weapp-tw.icebreaker.top/weapp-tailwindcss/docs/principle"><link data-rh="true" rel="alternate" href="https://weapp-tw.icebreaker.top/weapp-tailwindcss/docs/principle" hreflang="zh-cn"><link data-rh="true" rel="alternate" href="https://weapp-tw.icebreaker.top/weapp-tailwindcss/docs/principle" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://9Y7BJULSEW-dsn.algolia.net" crossorigin="anonymous"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S81Q4GRTPM"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-S81Q4GRTPM",{})</script>


<link rel="search" type="application/opensearchdescription+xml" title="weapp-tw 把tailwindcss带给小程序开发者们" href="/weapp-tailwindcss/opensearch.xml">



<link rel="preconnect" href="https://hm.baidu.com">
<meta name="baidu-site-verification" content="codeva-4ny6UzMmrn">
<script src="https://hm.baidu.com/hm.js?61f3de7065e36044e6d5f201632bc368" async></script><link rel="stylesheet" href="/weapp-tailwindcss/assets/css/styles.938b336a.css">
<script src="/weapp-tailwindcss/assets/js/runtime~main.56977c07.js" defer="defer"></script>
<script src="/weapp-tailwindcss/assets/js/main.c04efd52.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_rxPK" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/weapp-tailwindcss/"><div class="navbar__logo"><img src="/weapp-tailwindcss/img/logo.png" alt="weapp tailwindcss Logo" class="themedComponent_MvPY themedComponent--light_naW8"><img src="/weapp-tailwindcss/img/logo.png" alt="weapp tailwindcss Logo" class="themedComponent_MvPY themedComponent--dark_Jy8W"></div><b class="navbar__title text--truncate">weapp-tw</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/weapp-tailwindcss/docs/intro">指南</a><a class="navbar__item navbar__link" href="/weapp-tailwindcss/docs/community/templates">生态及解决方案</a><a class="navbar__item navbar__link" href="/weapp-tailwindcss/docs/issues">常见问题</a><a class="navbar__item navbar__link" href="/weapp-tailwindcss/docs/showcase">优秀案例展示</a><a class="navbar__item navbar__link" href="/weapp-tailwindcss/docs/migrations/v2">迁移</a><a class="navbar__item navbar__link" href="/weapp-tailwindcss/docs/options">配置项</a><a class="navbar__item navbar__link" href="/weapp-tailwindcss/docs/api">Types</a><a class="navbar__item navbar__link" href="/weapp-tailwindcss/docs/api-cli">Types-CLI</a><a href="https://icebreaker.top/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">博客<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_btZh"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/sonofmagic/weapp-tailwindcss" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_btZh"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_PrX1 colorModeToggle_AqBG"><button class="clean-btn toggleButton_lvwt toggleButtonDisabled__Hx8" type="button" disabled="" title="切换浅色/暗黑模式（当前为暗黑模式）" aria-label="切换浅色/暗黑模式（当前为暗黑模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_vsyE"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_fhDh"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_BAyc"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_fzR8"><div class="docsWrapper_fydZ"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_ufB6" type="button"></button><div class="docRoot_nXgd"><aside class="theme-doc-sidebar-container docSidebarContainer_Mmrq"><div class="sidebarViewport_mpmY"><div class="sidebar_wb6Z"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_H9QJ"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/weapp-tailwindcss/docs/intro">简介</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/weapp-tailwindcss/docs/quick-start/install">🔥快速开始(框架类)</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/weapp-tailwindcss/docs/quick-start/install">1. 安装与配置 tailwindcss</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/weapp-tailwindcss/docs/quick-start/this-plugin">2. 安装这个插件</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" tabindex="0" href="/weapp-tailwindcss/docs/quick-start/frameworks/uni-app">3. 各个框架的注册方式</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/weapp-tailwindcss/docs/quick-start/frameworks/uni-app">uni-app cli vue2 webpack</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/weapp-tailwindcss/docs/quick-start/frameworks/uni-app-vite">uni-app cli vue3 vite</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/weapp-tailwindcss/docs/quick-start/frameworks/hbuilderx">uni-app HbuilderX 使用方式</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/weapp-tailwindcss/docs/quick-start/frameworks/taro">Taro v3 (所有 框架)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/weapp-tailwindcss/docs/quick-start/frameworks/rax">Rax (react)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/weapp-tailwindcss/docs/quick-start/frameworks/mpx">mpx (原生增强)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/weapp-tailwindcss/docs/quick-start/frameworks/native">原生开发(打包方案)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/weapp-tailwindcss/docs/quick-start/frameworks/api">Nodejs API</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/weapp-tailwindcss/docs/quick-start/rem2rpx">4. rem 转 rpx (或 px)</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/weapp-tailwindcss/docs/quick-start/native/install">🔥快速开始(纯原生)</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/weapp-tailwindcss/docs/quick-start/native/install">1. 安装与配置 tailwindcss</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/weapp-tailwindcss/docs/quick-start/native/install-plugin">2. 安装这个插件并运行</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/weapp-tailwindcss/docs/quick-start/native/principle">更多的细节</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/weapp-tailwindcss/docs/community/templates">🔥快速开始(配置好的模板项目)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/weapp-tailwindcss/docs/community">生态以及解决方案</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/weapp-tailwindcss/docs/quick-start/intelliSense">IDE 智能提示设置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/weapp-tailwindcss/docs/principle">深入核心原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/weapp-tailwindcss/docs/how-to-contribute">如何贡献</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/weapp-tailwindcss/docs/tailwindcss-maintenance-book">Tailwindcss 原子类维护指南</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a href="https://github.com/sonofmagic/weapp-tailwindcss/issues/270" target="_blank" rel="noopener noreferrer" class="menu__link menuExternalLink_TLbf">谁在使用？<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_btZh"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></nav></div></div></aside><main class="docMainContainer_iRl0"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_M5ta"><div class="docItemContainer_oaKb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_MBqT" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/weapp-tailwindcss/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_gshy"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">深入核心原理</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_k4Dq theme-doc-toc-mobile tocMobile_XFtK"><button type="button" class="clean-btn tocCollapsibleButton_MA9_">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>tailwindcss in weapp 的原理</h1></header><h2 class="anchor anchorWithStickyNavbar_oBHm" id="2024-02-20-版本">2024-02-20 版本<a class="hash-link" aria-label="2024-02-20 版本的直接链接" title="2024-02-20 版本的直接链接" href="/weapp-tailwindcss/docs/principle#2024-02-20-版本">​</a></h2>
<h2 class="anchor anchorWithStickyNavbar_oBHm" id="前言">前言<a class="hash-link" aria-label="前言的直接链接" title="前言的直接链接" href="/weapp-tailwindcss/docs/principle#前言">​</a></h2>
<p>转眼又是一年，感觉是时候再来修订一下 <code>tailwindcss in weapp 的原理</code> 这篇文章了, 放心，这次我写作核心就是要让大多数人看懂！</p>
<h2 class="anchor anchorWithStickyNavbar_oBHm" id="什么是-weapp-tailwindcss">什么是 weapp-tailwindcss<a class="hash-link" aria-label="什么是 weapp-tailwindcss的直接链接" title="什么是 weapp-tailwindcss的直接链接" href="/weapp-tailwindcss/docs/principle#什么是-weapp-tailwindcss">​</a></h2>
<p>如果下一个定义的话，我把 <code>weapp-tailwindcss</code> 定义成一个 <strong>转义器</strong>，在我看来它就做了一件事情。那就是把 <code>tailwindcss</code> 中，小程序不兼容的写法，转化成小程序兼容的写法，并尽量保持生成的 <code>CSS</code> 效果一致罢了。</p>
<p>更加细一点的解释，就是允许开发者像 <code>tailwindcss</code> <code>h5</code> 环境里那样去写小程序，插件在背后帮助你把 <code>wxml</code>,<code>js</code>,<code>wxss</code> 等等这类产物的小程序兼容转化给做了。</p>
<p>仅仅如此罢了，做了一点小小的努力和贡献。</p>
<h2 class="anchor anchorWithStickyNavbar_oBHm" id="为什么需要-weapp-tailwindcss-">为什么需要 weapp-tailwindcss ？<a class="hash-link" aria-label="为什么需要 weapp-tailwindcss ？的直接链接" title="为什么需要 weapp-tailwindcss ？的直接链接" href="/weapp-tailwindcss/docs/principle#为什么需要-weapp-tailwindcss-">​</a></h2>
<p>因为小程序 <code>wxml</code>,<code>wxss</code> 等等文件/产物，本身是不支持 <code>Tailwindcss</code> 里面的一些特殊转义字符的，比如像 <code>[]</code>,<code>!</code>,<code>.</code> 等等。</p>
<p>经过测试后，<code>wxml</code> 中 <code>class</code> 属性，实际上只支持英文字母，数字，以及 <code>-</code> 和 <code>_</code> 这 <code>2</code> 个特殊字符，不支持的字符会被默认转化成<strong>空格</strong>，所以我们要做的就是把 <code>Tailwindcss</code> 选择器的写法，转化成小程序允许的方式。这也是核心包 <a href="https://github.com/sonofmagic/weapp-core" target="_blank" rel="noopener noreferrer"><code>@weapp-core/escape</code></a> 实现的功能。</p>
<p>插件大体的发展历程和方向，可以看下方以前的 <code>2023-03-19</code> 版本，在此不再叙述，接下来我们只来谈谈核心原理。</p>
<h2 class="anchor anchorWithStickyNavbar_oBHm" id="核心原理">核心原理<a class="hash-link" aria-label="核心原理的直接链接" title="核心原理的直接链接" href="/weapp-tailwindcss/docs/principle#核心原理">​</a></h2>
<p>插件的核心就是转义，那么具体是怎么做的呢？</p>
<p>实际上就是插件去解析编译后的 <code>wxml</code>,<code>js</code>,<code>wxss</code> 这些产物，并对它们进行改写。</p>
<p>工具方面， <code>weapp-tailwindcss</code> 使用 <code>htmlparser2</code> 去解析改造 <code>wxml</code>，使用 <code>babel</code> 去解析改造 <code>js</code> 和 <code>wxs</code>，使用 <code>postcss</code> 去解析改造所有的 <code>wxss</code>。</p>
<h2 class="anchor anchorWithStickyNavbar_oBHm" id="wxml"><code>wxml</code><a class="hash-link" aria-label="wxml的直接链接" title="wxml的直接链接" href="/weapp-tailwindcss/docs/principle#wxml">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_oBHm" id="为什么是-htmlparser2">为什么是 <code>htmlparser2</code><a class="hash-link" aria-label="为什么是-htmlparser2的直接链接" title="为什么是-htmlparser2的直接链接" href="/weapp-tailwindcss/docs/principle#为什么是-htmlparser2">​</a></h3>
<p>其实，<code>weapp-tailwindcss</code> 一开始使用的是 <code>@vivaxy/wxml</code>，这是一个 <code>wxml</code> 的 <code>ast</code> 工具，</p>
<p>但是它已经很久没有更新了，在很多场景，比如遇到内联的 <code>wxs</code> 的时候，会直接挂掉，而本身我也没有技术能力，去修复和完善这个 <code>wxml</code> 自动机，所以后续放弃了它。后来自己实现了一套基于正则的模板匹配引擎，但是再使用一段时间后，发现 <code>正则</code> 同样是有问题的，比如这样一个 <code>case</code>:</p>
<p><code>&lt;view class=&quot;{{2&gt;1?&#x27;xxx&#x27;:&#x27;yyy&#x27;}}&quot;&gt;&lt;/view&gt;</code></p>
<p>由于 <code>2&gt;1</code>的存在，它会与 <code>&lt;view class=&quot;{{2&gt;</code> 进行提前匹配并返回，这和我们的期望不符合，而且正则复杂了之后，其实匹配效率也是很低的 (具体可以在 <a href="https://regex101.com/" target="_blank" rel="noopener noreferrer">regex101</a> 进行测试和调试)，所以还是要使用 <code>ast</code> 工具才能做到兼顾效率的同时，做精确匹配转化。</p>
<p>所有，我还是要去寻找对应的 <code>xml/html ast</code> 工具来解析 <code>wxml</code>。在寻找的过程中，找到了符合条件的一些包，其中 <code>parse5</code> 对 <code>html5</code> 是严格的匹配，不怎么适用于 <code>wxml</code>，而 <code>htmlparser2</code> 是不严格标签匹配，所以经过测试之后，最后使用 <code>htmlparser2</code> 来处理 <code>wxml</code>。</p>
<h3 class="anchor anchorWithStickyNavbar_oBHm" id="如何使用-htmlparser2">如何使用 <code>htmlparser2</code><a class="hash-link" aria-label="如何使用-htmlparser2的直接链接" title="如何使用-htmlparser2的直接链接" href="/weapp-tailwindcss/docs/principle#如何使用-htmlparser2">​</a></h3>
<p>实际上很简单，我们可以在 <code>webpack</code> / <code>vite</code> / <code>gulp</code> 或者自己的构建脚本中，找到对应的生命周期 (<code>hooks</code>)，对 <code>wxml</code> 产物进行处理。</p>
<p>首先在获取到 <code>wxml</code> 产物的内容之后，把它构造成一个 <code>MagicString</code> 对象，因为 <code>magic-string</code> 这个库，操作字符串十分方便。</p>
<p>对产物内容字符串进行解析后，获取到所有 <code>class</code> 属性的内容，进行转义即可。代码示例如下:</p>
<div class="language-js codeBlockContainer_i86R theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_Es0n"><pre tabindex="0" class="prism-code language-js codeBlock_NCAI thin-scrollbar" style="color:#D4D4D4;background-color:#212121"><code class="codeBlockLines_mn2G"><span class="token-line" style="color:#D4D4D4"><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token keyword" style="color:#C586C0">as</span><span class="token plain"> htmlparser2 </span><span class="token keyword" style="color:#C586C0">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;htmlparser2&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">const</span><span class="token plain"> parser </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C586C0">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">htmlparser2</span><span class="token class-name punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token class-name" style="color:rgb(78, 201, 176)">Parser</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">onopentag</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token parameter" style="color:#9CDCFE">name</span><span class="token parameter punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token parameter" style="color:#9CDCFE"> attributes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">      </span><span class="token comment" style="color:rgb(106, 153, 85)">// code</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">onclosetag</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token parameter" style="color:#9CDCFE">tagname</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">      </span><span class="token comment" style="color:rgb(106, 153, 85)">// code</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">// ....</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">parser</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">write</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">wxmlCode</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">parser</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">end</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup_gg5K"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_hISb" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon__IAY"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_I8oK"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_oBHm" id="字符串以及变量绑定的处理">字符串以及变量绑定的处理<a class="hash-link" aria-label="字符串以及变量绑定的处理的直接链接" title="字符串以及变量绑定的处理的直接链接" href="/weapp-tailwindcss/docs/principle#字符串以及变量绑定的处理">​</a></h3>
<p>不过在获取到 <code>class</code> / <code>hover-class</code> 这些标签里面的内容之后，需要进行进一步解析和转化。</p>
<p>为什么？因为原生小程序可以使用 <code>{{expression}}</code> 表达式来动态绑定 <code>js</code> 的值，假设有一段 <code>wxml</code> 是这样写的:</p>
<div class="language-html codeBlockContainer_i86R theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_Es0n"><pre tabindex="0" class="prism-code language-html codeBlock_NCAI thin-scrollbar" style="color:#D4D4D4;background-color:#212121"><code class="codeBlockLines_mn2G"><span class="token-line" style="color:#D4D4D4"><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:#569CD6">view</span><span class="token tag" style="color:#569CD6"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">class</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">w-[13px] {{flag?&#x27;h-[23px]&#x27;:&#x27;h-[6px]&#x27;}} bg-[#123456] {{customClass}}</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:#569CD6">view</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><br></span></code></pre><div class="buttonGroup_gg5K"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_hISb" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon__IAY"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_I8oK"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这时候你就必须在匹配 <code>class</code> 属性值的情况下，对字符串进行转义，再对 <code>{{}}</code> 里包裹的 <code>js</code> 表达式，进行转义，使得结果变成:</p>
<div class="language-html codeBlockContainer_i86R theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_Es0n"><pre tabindex="0" class="prism-code language-html codeBlock_NCAI thin-scrollbar" style="color:#D4D4D4;background-color:#212121"><code class="codeBlockLines_mn2G"><span class="token-line" style="color:#D4D4D4"><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:#569CD6">view</span><span class="token tag" style="color:#569CD6"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">class</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">w-_13px_ {{flag?&#x27;h-_23px_&#x27;:&#x27;h-_6px_&#x27;}} bg-_#123456_ {{customClass}}</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:#569CD6">view</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><br></span></code></pre><div class="buttonGroup_gg5K"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_hISb" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon__IAY"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_I8oK"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>那么怎么做呢？也很简单，我们通过 <code>htmlparser2</code> 匹配 <code>class</code> 属性，可以获取到 <code>w-[13px] {{flag?&#x27;h-[23px]&#x27;:&#x27;h-[6px]&#x27;}} bg-[#123456] {{customClass}}</code> 这个字符串。</p>
<p>然后对这个字符串进行 <code>{{}}</code> 表达式匹配，在 <code>{{}}</code> 表达式匹配之外的字符串，直接进行转义。在 <code>{{}}</code> 表达式内的代码，使用 <code>babel</code> 进行解析，然后获取到所有的 <code>js</code> 字符串字面量，进行转义即可。</p>
<p>同时在进行匹配和转义的时候，实际上我们是可以获取到对应字符串 <code>start</code> 和 <code>end</code> 的下标的，这就为我们使用 <code>MagicString</code> 进行替换，提供了良好的基础。</p>
<h2 class="anchor anchorWithStickyNavbar_oBHm" id="js--wxs">js / wxs<a class="hash-link" aria-label="js / wxs的直接链接" title="js / wxs的直接链接" href="/weapp-tailwindcss/docs/principle#js--wxs">​</a></h2>
<p>我们同样要对所有的 <code>js</code> 里面的字符串，进行扫描，发现它是 <code>tailwindcss</code> 的类名，就需要进行转义。</p>
<p>我们还是以上方的代码片段为例:</p>
<div class="language-html codeBlockContainer_i86R theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_Es0n"><pre tabindex="0" class="prism-code language-html codeBlock_NCAI thin-scrollbar" style="color:#D4D4D4;background-color:#212121"><code class="codeBlockLines_mn2G"><span class="token-line" style="color:#D4D4D4"><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:#569CD6">view</span><span class="token tag" style="color:#569CD6"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">class</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">w-[13px] {{flag?&#x27;h-[23px]&#x27;:&#x27;h-[6px]&#x27;}} bg-[#123456] {{customClass}}</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:#569CD6">view</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><br></span></code></pre><div class="buttonGroup_gg5K"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_hISb" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon__IAY"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_I8oK"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在 <code>wxml</code> 的处理过程中，看似我们已经解决了大部分 <code>class</code> 内容的转义的，但是开发者也可能在 <code>customClass</code> 绑定的 <code>js</code> 字符串中，直接去编写 <code>tailwindcss</code> 的类名。比如:</p>
<div class="language-js codeBlockContainer_i86R theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_Es0n"><pre tabindex="0" class="prism-code language-js codeBlock_NCAI thin-scrollbar" style="color:#D4D4D4;background-color:#212121"><code class="codeBlockLines_mn2G"><span class="token-line" style="color:#D4D4D4"><span class="token function" style="color:rgb(220, 220, 170)">Page</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token literal-property property" style="color:#9CDCFE">data</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    </span><span class="token literal-property property" style="color:#9CDCFE">customClass</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;bg-[url(&#x27;https://xxx.com/xx.webp&#x27;)] text-[#123456] text-[50px] bg-[#fff]&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup_gg5K"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_hISb" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon__IAY"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_I8oK"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>又或者直接在 <code>wxs</code> 里面去写类名，那么这时候怎么办呢？获取所有字符串字面量和模板字符串，进行转义即可吗？</p>
<p>显然这是不行的，一个应用程序里面，大部分的字符串字面量都是和 <code>tailwindcss</code> 无关的，假如全部转化只会把应用程序弄奔溃。</p>
<p>那么，我们是否有什么方式，去获取到 <code>tailwindcss</code> 的上下文，再从里面把它所有的类名提取出来，再和我们应用程序里面的字符串进行匹配，从而做到精确转义呢？可是 <code>tailwindcss</code> 只是一个 <code>postcss</code> 插件啊，怎么从 <code>webpack</code> / <code>vite</code> 插件里，把一个 <code>postcss</code> 插件里的内容取出来呢？</p>
<p>很开心的是我办到了，这就是 <a href="https://github.com/sonofmagic/tailwindcss-mangle" target="_blank" rel="noopener noreferrer">tailwindcss-mangle</a> 做的事情。</p>
<p>通过这种方式，我们可以在 <code>postcss</code> / <code>postcss-loader</code> 执行之后，把 <code>tailwindcss</code> 执行时的 1 或者多个上下文给取出来，交给插件进行使用，从而达到所有 <code>js</code> 字符串字面量筛选的效果，简单实用 <code>babel</code> 实现的代码如下:</p>
<div class="language-js codeBlockContainer_i86R theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_Es0n"><pre tabindex="0" class="prism-code language-js codeBlock_NCAI thin-scrollbar" style="color:#D4D4D4;background-color:#212121"><code class="codeBlockLines_mn2G"><span class="token-line" style="color:#D4D4D4"><span class="token keyword" style="color:#C586C0">let</span><span class="token plain"> </span><span class="token literal-property property" style="color:#9CDCFE">ast</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> ParseResult</span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">File</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">parse</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">rawSource</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    </span><span class="token literal-property property" style="color:#9CDCFE">sourceType</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;unambiguous&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">const</span><span class="token plain"> ms </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C586C0">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">MagicString</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">rawSource</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">const</span><span class="token plain"> </span><span class="token literal-property property" style="color:#9CDCFE">ropt</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> TraverseOptions</span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">Node</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token literal-property property" style="color:#9CDCFE">StringLiteral</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">enter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token parameter" style="color:#9CDCFE">p</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">      </span><span class="token comment" style="color:rgb(106, 153, 85)">// set 为 tailwindcss 上下文里所有生效的 classnames</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">      </span><span class="token keyword" style="color:#C586C0">if</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">set</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">has</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">p</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)">// do escape</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        </span><span class="token keyword" style="color:#C586C0">const</span><span class="token plain"> value </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">escape</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">p</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        ms</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">update</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">start</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> end</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token function" style="color:rgb(220, 220, 170)">traverse</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ast</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> ropt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">const</span><span class="token plain"> code </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ms</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">toString</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup_gg5K"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_hISb" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon__IAY"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_I8oK"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>通过这种方式来精确的把 <code>js</code> / <code>wxs</code> 里面字符串字面量，给转义成小程序允许的方式。</p>
<p>这里我们使用 <code>babel</code> 作为 <code>js ast</code> 的工具，因为目前为止它也是最流行的这方面的包，但是出于效率上的考虑，未来将会使用 <code>swc</code> 并编写 <code>swc</code> 插件的方式，来取代 <code>babel</code>。</p>
<h2 class="anchor anchorWithStickyNavbar_oBHm" id="wxss">wxss<a class="hash-link" aria-label="wxss的直接链接" title="wxss的直接链接" href="/weapp-tailwindcss/docs/principle#wxss">​</a></h2>
<p>最后就是样式的处理了，在转义完 <code>wxml</code>,<code>js</code> 和 <code>wxs</code> 后，我们需要把 <code>wxss</code> 里 <code>tailwindcss</code> 生成的样式，转化成与之前的 <code>wxml</code>,<code>js</code>,<code>wxs</code> 中匹配的方式。这样才能做到类名的 11 对应，从而达到我们最终的目的。</p>
<p>那么怎么做呢？这里我们选用的工具，自然是 <code>postcss</code>，它是目前用 <code>js</code> 编写的最流行的一个 <code>css ast</code> 工具，它要比 <code>css-tree</code> 生态好很多，也有很多现成的稳定插件可以使用，帮助我们完成针对 <code>css</code> 各种各样的处理。</p>
<p>所以最后我们所要完成的工作，就是把 <code>tailwindcss</code> 的产物，转化成与 <code>wxml</code>,<code>js</code> 和 <code>wxs</code> 匹配，且小程序能够适配的样子了！</p>
<p>怎么做？也很简单，直接使用 <code>postcss</code> 扫描 <code>wxss</code> 里面所有的 <code>Rule</code> 节点，然后获取到里面的选择器，进行转义即可！</p>
<h3 class="anchor anchorWithStickyNavbar_oBHm" id="postcss-对象简单介绍">postcss 对象简单介绍<a class="hash-link" aria-label="postcss 对象简单介绍的直接链接" title="postcss 对象简单介绍的直接链接" href="/weapp-tailwindcss/docs/principle#postcss-对象简单介绍">​</a></h3>
<p>什么是 <code>Rule</code> 节点？在 <code>postcss</code> 插件中，大致有这 <code>5</code> 类对象(其实还有一个 <code>Document</code> ):</p>
<ul>
<li><code>Root</code>: CSS tree 的根结点，通常可以代表整个 CSS 文件.</li>
<li><code>AtRule</code>: 以 <code>@</code> 开始的 CSS 语句，比如 <code>@charset &quot;UTF-8&quot;</code> 或者 <code>@media (screen) {}</code>.</li>
<li><code>Rule</code>: 普通的选择器节点，内部由 CSS 声明填充，比如 <code>.btn { /*decls*/ }</code>.</li>
<li><code>Declaration</code>: key-value 键值对，代表 CSS 声明，比如 <code>color: black</code>;</li>
<li><code>Comment</code>: CSS 注释.</li>
</ul>
<p>详见 <a href="https://postcss.org/docs/writing-a-postcss-plugin#step-find-nodes" target="_blank" rel="noopener noreferrer">writing-a-postcss-plugin</a></p>
<p>通过这些对象，<code>postcss</code> 完成了对 <code>CSS</code> 的抽象，从而让我们可以通过操作这些对象来对 <code>CSS</code> 进行增删改查。</p>
<h3 class="anchor anchorWithStickyNavbar_oBHm" id="tailwindcss-简单原理和运行表现">Tailwindcss 简单原理和运行表现<a class="hash-link" aria-label="Tailwindcss 简单原理和运行表现的直接链接" title="Tailwindcss 简单原理和运行表现的直接链接" href="/weapp-tailwindcss/docs/principle#tailwindcss-简单原理和运行表现">​</a></h3>
<p>在转化所有的 <code>Rule</code> 节点之前，我们先分析一下 <code>Tailwindcss</code> 的原理，它也是一个 <code>postcss</code> 插件，它通过提取 <code>content</code> 配置里面的 <code>glob</code> 表达式 or <code>vfile</code> 对象，从里面提取到符合它规则的字符串，然后生成大量的 <code>AtRule</code> / <code>Rule</code> 对象保存起来。</p>
<p>然后再扫描到我们注册 <code>Tailwindcss</code> 的地方:</p>
<div class="language-css codeBlockContainer_i86R theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_Es0n"><pre tabindex="0" class="prism-code language-css codeBlock_NCAI thin-scrollbar" style="color:#D4D4D4;background-color:#212121"><code class="codeBlockLines_mn2G"><span class="token-line" style="color:#D4D4D4"><span class="token atrule rule" style="color:#C586C0">@tailwind</span><span class="token atrule" style="color:#569CD6"> base</span><span class="token atrule punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token atrule rule" style="color:#C586C0">@tailwind</span><span class="token atrule" style="color:#569CD6"> components</span><span class="token atrule punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token atrule rule" style="color:#C586C0">@tailwind</span><span class="token atrule" style="color:#569CD6"> utilities</span><span class="token atrule punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup_gg5K"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_hISb" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon__IAY"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_I8oK"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>把这些对象进行展开，替换掉原先的 <code>@tailwind xxx;</code>，从而达到了写什么， <code>CSS</code> 就自动生成什么的效果。</p>
<p>其中  你可以把 <code>base</code> / <code>components</code> / <code>utilities</code> 理解成一个个 <code>layer</code> 标志位，不同的 <code>AtRule</code> / <code>Rule</code> 对象集合，会在它对应的 <code>layer</code> 出展开。比如 <code>base</code> 负责所有的 <code>css vars</code> 和 <code>preflight css</code> 注入，<code>utilities</code> 负责所有原子工具类的生成。</p>
<p>同时它们再通过 <code>@layer</code> 来控制它们的优先级，从而做到它们之间的 <code>CSS</code> 不会产生优先级相互覆盖冲突的问题。</p>
<blockquote>
<p><code>@layer</code> 实际上是原生 <code>CSS</code> 的一个实验性功能，用来声明一个 级联层,从而让开发者更容易的控制自己 CSS 代码的优先级罢了。这里我们能使用 <code>@layer</code> 是因为这个功能被 <code>tailwindcss</code> 用它自己的方式实现了，使得我们可以在 <code>CSS</code> 里预先使用 <code>@layer</code> 罢了，最终产物里面是没有 <code>@layer</code> 的。相关文档详见 <a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/@layer" target="_blank" rel="noopener noreferrer">MDN @layer</a></p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_oBHm" id="开始转化">开始转化<a class="hash-link" aria-label="开始转化的直接链接" title="开始转化的直接链接" href="/weapp-tailwindcss/docs/principle#开始转化">​</a></h3>
<p>首先我们先简单声明一个 <code>postcss</code> 插件:</p>
<div class="language-ts codeBlockContainer_i86R theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_Es0n"><pre tabindex="0" class="prism-code language-ts codeBlock_NCAI thin-scrollbar" style="color:#D4D4D4;background-color:#212121"><code class="codeBlockLines_mn2G"><span class="token-line" style="color:#D4D4D4"><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> </span><span class="token keyword" style="color:#C586C0">type</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> PluginCreator </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#C586C0">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;postcss&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> ruleTransformSync </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#C586C0">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;../selectorParser&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">const</span><span class="token plain"> creator</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> PluginCreator</span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">Options</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token keyword" style="color:#C586C0">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    postcssPlugin</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">Rule</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">rule</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">      </span><span class="token function" style="color:rgb(220, 220, 170)">ruleTransformSync</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">rule</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> options</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">creator</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">postcss </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean" style="color:#569CD6">true</span><br></span></code></pre><div class="buttonGroup_gg5K"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_hISb" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon__IAY"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_I8oK"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里我们把针对 <code>Rule</code> 的转化，封装进 <code>ruleTransformSync</code> 这个方法里:</p>
<p>这里我们需要用到 <code>postcss-selector-parser</code> 来对 <code>Rule</code> 中的选择器，做更加细致的转化。</p>
<p>因为 <code>postcss</code> 中的 <code>Rule</code> 对象的选择器千变万化，可以非常的简单，也可以非常的复杂，你单独把它当作字符串来处理，很容易出现问题。</p>
<p>所以我们需要 <code>postcss-selector-parser</code> 来解析 <code>Rule#selector</code> 然后进行修改再转化回字符串。</p>
<p>例如:</p>
<div class="language-ts codeBlockContainer_i86R theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_Es0n"><pre tabindex="0" class="prism-code language-ts codeBlock_NCAI thin-scrollbar" style="color:#D4D4D4;background-color:#212121"><code class="codeBlockLines_mn2G"><span class="token-line" style="color:#D4D4D4"><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> selectorParser </span><span class="token keyword" style="color:#C586C0">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;postcss-selector-parser&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> </span><span class="token keyword" style="color:#C586C0">type</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> Rule </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#C586C0">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;postcss&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> </span><span class="token keyword" style="color:#C586C0">type</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> IStyleHandlerOptions </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#C586C0">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;@/types&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">export</span><span class="token plain"> </span><span class="token keyword" style="color:#C586C0">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:rgb(220, 220, 170)">ruleTransformSync</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">rule</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Rule</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> options</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> IStyleHandlerOptions</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token keyword" style="color:#C586C0">const</span><span class="token plain"> transformer </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">selectorParser</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">selectors</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    selectors</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">walk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">selector</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">      </span><span class="token comment" style="color:rgb(106, 153, 85)">// do something with the selector</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token keyword" style="color:#C586C0">return</span><span class="token plain"> transformer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">transformSync</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">rule</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    lossless</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token boolean" style="color:#569CD6">false</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    updateSelector</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token boolean" style="color:#569CD6">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup_gg5K"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_hISb" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon__IAY"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_I8oK"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们通过对 <code>selectors</code> 的 <code>walk</code>，再方法里面去筛选和修改节点，从而达到我们替换和转义 <code>Rule#selector</code> 的效果。</p>
<p>这样就可以去转义所有的 <code>Tailwindcss</code> 生成的所有节点了！</p>
<h2 class="anchor anchorWithStickyNavbar_oBHm" id="大功告成">大功告成<a class="hash-link" aria-label="大功告成的直接链接" title="大功告成的直接链接" href="/weapp-tailwindcss/docs/principle#大功告成">​</a></h2>
<p>最终在这 3 大部分完成之后，<code>weapp-tailwindcss</code> 的核心功能就完成了！</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_oBHm" id="2023-03-19-版本">2023-03-19 版本<a class="hash-link" aria-label="2023-03-19 版本的直接链接" title="2023-03-19 版本的直接链接" href="/weapp-tailwindcss/docs/principle#2023-03-19-版本">​</a></h2>
<p>(2023-03-19) 版本，现在看了一下，已经比较老了，有空再改进改进。</p>
<h2 class="anchor anchorWithStickyNavbar_oBHm" id="前言-1">前言<a class="hash-link" aria-label="前言的直接链接" title="前言的直接链接" href="/weapp-tailwindcss/docs/principle#前言-1">​</a></h2>
<p>笔者对 <code>tailwindcss</code> 这一类库的理解还算比较深刻。之前就已经撰写并发布过相关的许多包，比如像 <a href="https://github.com/sonofmagic/tailwindcss-miniprogram-preset" target="_blank" rel="noopener noreferrer"><code>tailwindcss-miniprogram-preset</code></a>, <a href="https://github.com/sonofmagic/weapp-tailwindcss-webpack-plugin" target="_blank" rel="noopener noreferrer"><code>weapp-tailwindcss-webpack-plugin</code></a> <a href="https://github.com/sonofmagic?tab=repositories&amp;q=tailwindcss&amp;type=&amp;language=&amp;sort=" target="_blank" rel="noopener noreferrer">等等大堆的包</a>。</p>
<p>最近我发布了 <a href="https://github.com/sonofmagic/weapp-tailwindcss-webpack-plugin" target="_blank" rel="noopener noreferrer"><code>weapp-tailwindcss-webpack-plugin</code></a> 的 <code>2.0.0</code>版本，增加了一些核心特性。想着现在也是时候，回顾总结一下这个插件的原理和历程了。回首<code>npm</code>版本发布历史，看到当年发布的第一个正式版，还是在 <code>2022/2/3</code> 号，到现在也已经过去了<code>1</code>年多的时间了，想想岁月真是如白驹过隙，等着等着我们就老了。</p>
<h2 class="anchor anchorWithStickyNavbar_oBHm" id="这个插件是做什么的">这个插件是做什么的？<a class="hash-link" aria-label="这个插件是做什么的？的直接链接" title="这个插件是做什么的？的直接链接" href="/weapp-tailwindcss/docs/principle#这个插件是做什么的">​</a></h2>
<p>简单概括一下，就是把 <code>tailwindcss</code> 相关的特性，带入进小程序开发中。</p>
<p>为什么需要它呢？核心原因就是，小程序这个平台不像<code>h5</code>那么自由，有很多各式各样的束缚与非标准化的 <code>API</code>。我们以微信小程序为例：</p>
<p>同<code>css</code>相比，<code>wxss</code>有着更少的选择器支持，同<code>wxml</code>相比，<code>wxml</code>有着更少的字符集支持，<code>js</code> 和 <code>wxs</code> 的运行也是分离的(<code>wxs</code>语法像是一个低版本<code>js</code>)。</p>
<p>更不用说那些该有的全局对象一个都没有了，比如 <code>Blob</code>,<code>File</code>,<code>FormData</code>, <code>WebSocket</code>,<code>fetch</code>,<code>XmlHttpRequest</code>等等了，这导致许多浏览器包，安装下来无法运行  。</p>
<blockquote>
<p>举个例子，最近我在做服务端 graphql 改造，市面上主流的 <code>graphql client</code> 直接安装运行会立即报错，因为缺少全局对象，为了兼容它们，于是就写了 <a href="https://www.npmjs.com/package/weapp-websocket" target="_blank" rel="noopener noreferrer"><code>weapp-websocket</code></a> 和 <a href="https://www.npmjs.com/package/weapp-graphql-request" target="_blank" rel="noopener noreferrer"><code>weapp-fetch</code></a> 分别来实现 <code>subscriptions</code> 和 <code>query/mutation</code>。目前在项目里使用，运转良好。</p>
</blockquote>
<p>总的来说，由于缺少许多特定的对象和语法上的限制，一些在 <code>h5</code> 上通用的流行库，很有可能在小程序里跑不起来。<code>tailwindcss</code> 便是其中之一，而这个插件就能帮助你在小程序里使用它。</p>
<h2 class="anchor anchorWithStickyNavbar_oBHm" id="原理篇">原理篇<a class="hash-link" aria-label="原理篇的直接链接" title="原理篇的直接链接" href="/weapp-tailwindcss/docs/principle#原理篇">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_oBHm" id="utility-first-css-framework">utility-first CSS framework<a class="hash-link" aria-label="utility-first CSS framework的直接链接" title="utility-first CSS framework的直接链接" href="/weapp-tailwindcss/docs/principle#utility-first-css-framework">​</a></h3>
<p>其实吧，市面上的 <code>tailwindcss</code>/<code>windicss</code>/<code>unocss</code> 做的是一回事情。如果用比喻来形容，那么它们就是个带着滤网的字符串漏斗。它们对开发者编写的代码文件内容进行读取，并分割成海量的字符串放入漏斗中，然后经过滤网的过滤，符合条件的就去生成原子类，其余的&quot;残渣&quot;则忽略。</p>
<p>其中 <code>tailwindcss</code> 大多作为 <code>postcss plugin</code> 来使用的，它源码里自己实现了一个文件读取机制(也就是 <code>tailwind.config.js</code> 中的 <code>content</code> 配置项 )，来对我们编写的代码进行提取。</p>
<p>而 <code>windicss</code>/<code>unocss</code> 则是依赖 <code>webpack/rollup/vite</code> 这类的 <code>bundler</code>，在打包的过程中获取到 <code>Source / Asset / Chunk</code> 这类的对象，从而提取字符串的。虽然目前 <code>windicss</code>/<code>unocss</code> 都有对应的 <code>postcss plugin</code> 的实现，但是它们大多都是作为实验性质的，并不能很好的复刻它们打包插件的体验。</p>
<p>是什么造成了它们的不同呢？</p>
<p>这点其实就要说到 <code>unocss/windicss</code> 它们的优点了。目前 <code>tailwindcss postcss plugin</code> 实际上只有<strong>读</strong>的能力，它来读取我们写的代码，生成原子类。而 <code>windicss</code>/<code>unocss</code> 它们大多作为一个 <code>webpack/vite/rollup plugin</code> 来使用的，所以它们不但拥有读的能力，还拥有<strong>修改</strong>的能力。所以它们能写出这样的代码:</p>
<div class="language-html codeBlockContainer_i86R theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_Es0n"><pre tabindex="0" class="prism-code language-html codeBlock_NCAI thin-scrollbar" style="color:#D4D4D4;background-color:#212121"><code class="codeBlockLines_mn2G"><span class="token-line" style="color:#D4D4D4"><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:#569CD6">button</span><span class="token tag" style="color:#569CD6"> </span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token tag" style="color:#569CD6">  </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">bg</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">blue-400 hover:blue-500 dark:blue-500 dark:hover:blue-600</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:#569CD6"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token tag" style="color:#569CD6">  </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">text</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">sm white</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:#569CD6"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token tag" style="color:#569CD6">  </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">font</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">mono light</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:#569CD6"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token tag" style="color:#569CD6">  </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">p</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">y-2 x-4</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:#569CD6"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token tag" style="color:#569CD6">  </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">border</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">2 rounded blue-200</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:#569CD6"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token tag" style="color:#569CD6"></span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  Button</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:#569CD6">button</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:#569CD6">div</span><span class="token tag" style="color:#569CD6"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">m-2</span><span class="token tag" style="color:#569CD6"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">rounded</span><span class="token tag" style="color:#569CD6"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">text-teal-400</span><span class="token tag" style="color:#569CD6"> </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><br></span></code></pre><div class="buttonGroup_gg5K"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_hISb" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon__IAY"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_I8oK"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>实际上就是在打包的插件内，展开覆写罢了，本质上还是个语法糖。</p>
<p>另外目前你选择这种原子类框架的时候，要不选择 <code>tailwindcss</code> 要不就 <code>unocss</code>，目前看起来 <code>windicss</code> 已经死了。</p>
<h3 class="anchor anchorWithStickyNavbar_oBHm" id="小程序兼容">小程序兼容<a class="hash-link" aria-label="小程序兼容的直接链接" title="小程序兼容的直接链接" href="/weapp-tailwindcss/docs/principle#小程序兼容">​</a></h3>
<p>上面说了这么多，接下来来聊聊它们对小程序的兼容，事实上，市面这么多转义的插件，预设啥的，都是一回事。</p>
<p>思路大多就是把这些原子类<code>css</code>框架，生成的 <code>class</code> 通过重命名，转义，再覆写的方式，去兼容小程序环境。</p>
<p>说的具体一些，就是对打包后的产物进行修改，把其中的 <code>wxml</code> 里开发者撰写的 <code>className</code> 进行转义，把 <code>js</code> 里写的要应用到 <code>dom</code> 节点上的 <code>className</code> 也进行转义，同时还要对 <code>wxss</code> 里生成的 <code>css</code> 选择器进行转义。</p>
<p>而这些核心中的核心，便是转义后类名和选择器，一定要相互匹配！！不然生成的结果就是完全错误的。</p>
<h2 class="anchor anchorWithStickyNavbar_oBHm" id="笔者的实现">笔者的实现<a class="hash-link" aria-label="笔者的实现的直接链接" title="笔者的实现的直接链接" href="/weapp-tailwindcss/docs/principle#笔者的实现">​</a></h2>
<p>前面说了这么多，接下来来讲讲我自己的实现。</p>
<p>实际上我一开始的实现也很简单，在第一版本初期，我选择写了这样一个 <code>webpack plugin</code>：</p>
<ol>
<li>它内部用 <code>wxml ast</code> 来解析所有的 <code>wxml</code>模板,以此来获取所有的 <code>className</code> 进行解析和替换</li>
<li>使用 <code>postcss</code> 来解析所有的 <code>wxss</code>，以此对所有的<code>css</code>选择器进行修改</li>
<li>使用 <code>babel</code> 来解析所有的 <code>js</code>/<code>jsx</code>，以此来动态修改 <code>jsx?</code> 里所以满足条件的字面量 (<code>StringLiteral</code>)。</li>
</ol>
<p>然而理想很丰满，现实很骨感，在实现的过程中，困难一个一个浮现出来了：</p>
<h3 class="anchor anchorWithStickyNavbar_oBHm" id="js里的字面量转义很容易误伤">js里的字面量转义很容易误伤<a class="hash-link" aria-label="js里的字面量转义很容易误伤的直接链接" title="js里的字面量转义很容易误伤的直接链接" href="/weapp-tailwindcss/docs/principle#js里的字面量转义很容易误伤">​</a></h3>
<p>一开始想着直接匹配并且替换掉符合要求的 <code>js</code> 的字面量，于是便兴致勃勃从 <code>tailwindcss</code> 源码里，拷贝来了解析提取器的正则，并在打包后进行匹配和替换。</p>
<p>然而这个方案失败了，原因是<code>tailwindcss</code>这个正则匹配有可能会把 <code>webpack</code> 它默认注入的一些<code>js code</code>的一些字面量，也给匹配进来，从而造成大面积误伤。这种误伤会导致 <code>js</code> 加载的失败，应用直接就挂了。所以暂时把 <code>js</code>字面量动态修改给去除掉了。同时导出了一个手动标记替换位置的方法：</p>
<div class="language-js codeBlockContainer_i86R theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_Es0n"><pre tabindex="0" class="prism-code language-js codeBlock_NCAI thin-scrollbar" style="color:#D4D4D4;background-color:#212121"><code class="codeBlockLines_mn2G"><span class="token-line" style="color:#D4D4D4"><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> replaceJs </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#C586C0">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;weapp-tailwindcss-webpack-plugin/replace&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">const</span><span class="token plain"> cardsColor </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">reactive</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token function" style="color:rgb(220, 220, 170)">replaceJs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;bg-[#4268EA] shadow-indigo-100&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token function" style="color:rgb(220, 220, 170)">replaceJs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;bg-[#123456] shadow-blue-100&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup_gg5K"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_hISb" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon__IAY"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_I8oK"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这样虽然解决了误伤的问题，但是带来了一些代码的入侵性，导致了开发体验不佳。不过这个问题在 <code>2.0.0</code> 解决了，请继续往下看。</p>
<h3 class="anchor anchorWithStickyNavbar_oBHm" id="多框架兼容">多框架兼容<a class="hash-link" aria-label="多框架兼容的直接链接" title="多框架兼容的直接链接" href="/weapp-tailwindcss/docs/principle#多框架兼容">​</a></h3>
<blockquote>
<p>源码 <code>framework</code> 部分</p>
</blockquote>
<p>正如你看到的，我的这个 <code>plugin</code> 是兼容市面上，几乎所有还活着的主流开发框架的。在开始设计兼容方案的过程中，我发现这些框架编译成小程序的产物各有不同，一类是以 <code>uni-app</code>/<code>mpx</code>/<code>native(原生)</code>为例，它们就是按部就班的把类 <code>vue</code> 模板的写法，转义成小程序模板写法。另外一类是以 <code>taro</code>，<code>rax</code>，<code>remax</code> 为代表的 <code>jsx</code> 写法，这种写法的产物，最大的特点就是页面与组件的 <code>wxml</code> 里往往都是这样的结构：</p>
<div class="language-html codeBlockContainer_i86R theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_Es0n"><pre tabindex="0" class="prism-code language-html codeBlock_NCAI thin-scrollbar" style="color:#D4D4D4;background-color:#212121"><code class="codeBlockLines_mn2G"><span class="token-line" style="color:#D4D4D4"><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:#569CD6">import</span><span class="token tag" style="color:#569CD6"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">src</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">../../base.wxml</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:#569CD6">template</span><span class="token tag" style="color:#569CD6"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">is</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">taro_tmpl</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:#569CD6"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">data</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">{{root:root}}</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:#569CD6"> </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><br></span></code></pre><div class="buttonGroup_gg5K"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_hISb" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon__IAY"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_I8oK"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>而 <code>base.wxml</code> 文件内则是大量的条件渲染语句，然后在 <code>js</code> 里生成一个对象传入其中，就把整个页面和逻辑渲染出来了。这个方案显然会比模板方案要灵活许多。个人总结，一种偏静态编译，一种偏动态。</p>
<p>所以开始写的时候插件也分成了 <code>2</code> 个版本，一个是 <code>TemplatePlugin</code> 专门用来处理偏静态的这种框架，一个是 <code>JsxPlugin</code> 负责动态的方案。这 <code>2</code> 种插件的侧重点不同，一个主要替换模板代码，一个则主要转义 <code>jsx</code>，就开发难度来说 <code>jsx</code> 插件要难上许多。</p>
<h4 class="anchor anchorWithStickyNavbar_oBHm" id="模板插件">模板插件<a class="hash-link" aria-label="模板插件的直接链接" title="模板插件的直接链接" href="/weapp-tailwindcss/docs/principle#模板插件">​</a></h4>
<blockquote>
<p>源码 <code>base/BaseTemplatePlugin</code> 和 <code>wxml</code> 部分</p>
</blockquote>
<p>模板那个插件，要做的是解析所有的 <code>dom</code> 的 <code>class</code> 属性，但是这个属性里很有可能会存在 <code>js</code>表达式(<code>{{}}</code>包裹的部分)。</p>
<p>如果是不带表达式的，可以直接转义覆写，带表达式的会稍微复杂一点，我需要去预估开发者所使用的语法，比如开发者经常会使用一些数组绑定的语法，或者多元条件运算符，例如 <code>x?y:z?a:b</code> 来撰写类名。这就代表着我们需要像解析 <code>js</code> 那样去解析 <code>{{}}</code> 内部包着的表达式，再通过语法的检测去进行替换。</p>
<p>比如 <code>x?y:z?a:b</code> 派生的 <code>{{ flag ? &#x27;bg-[#123456]&#x27; : otherFlag ? &#x27;text-[50px]&#x27; : &#x27;text-[#654321]&#x27; }}</code> 我们就需要匹配 <code>3</code> 个字面量进行转义。</p>
<h4 class="anchor anchorWithStickyNavbar_oBHm" id="jsx插件">jsx插件<a class="hash-link" aria-label="jsx插件的直接链接" title="jsx插件的直接链接" href="/weapp-tailwindcss/docs/principle#jsx插件">​</a></h4>
<blockquote>
<p>源码 <code>base/BaseJsxPlugin</code> 和 <code>jsx</code> 部分</p>
</blockquote>
<p>这个插件的开发难度更高，因为我发现就单单 <code>taro</code> 一个框架，它就支持 <code>react</code>/ <code>preact</code>/ <code>vue2</code> / <code>vue3</code> 这些框架，要命的是，<code>react</code>/<code>vue2</code>/<code>vue3</code> 它们构建出来的产物，有很大的不同。</p>
<blockquote>
<p>这点你可以通过我 <code>src/jsx</code> 目录下的源码，和相应的<code>jest</code>单元测试快照，查看它们的差别。</p>
</blockquote>
<p>所以我在配置项里，除了原先的 <code>appType</code>(框架) 之外又加了一个 <code>framework</code> 专门提供给 <code>taro</code>，通过传入 <code>react/vue2/vue3</code> 让它们走各自不同的 <code>jsx?</code> 替换策略。</p>
<p>当然这样远远没有解决问题，毕竟原先插件是在 <code>processAssets</code> 这个<code>hook</code>去执行的核心逻辑，相比较来说还是偏晚的，还可能有误伤的问题存在。为此我做了一些努力：</p>
<ol>
<li>在替换字面量时，只匹配 <code>react/vue2/vue3</code>的<code>return</code>模板部分代码，放弃函数作用域内字面量的匹配和替换。</li>
<li>为了让这个转义替换的范围足够的精确，就必须要尽可能的提前执行。于是基于这个思路，我想到了在插件里，动态去插入一个自己的 <code>webpack-loader</code>:<code>jsx-rename-loader</code> (见源码 <code>src/loader</code> )</li>
</ol>
<p>这个 <code>loader</code> 会被动态的插入 <code>jsx?</code> 文件的加载读取序列中，并确保它在队列的最先执行，即 <code>babel-loader</code> 或 <code>ts-loader</code> 之前。这样在这个<code>loader</code>内部执行转义的时候，得到的原始内容就非常贴近用户自己编写的代码了。</p>
<h4 class="anchor anchorWithStickyNavbar_oBHm" id="webpack45-和-vite-的兼容">webpack4/5 和 vite 的兼容<a class="hash-link" aria-label="webpack4/5 和 vite 的兼容的直接链接" title="webpack4/5 和 vite 的兼容的直接链接" href="/weapp-tailwindcss/docs/principle#webpack45-和-vite-的兼容">​</a></h4>
<blockquote>
<p>源码 <code>base</code> -&gt; <code>v4/v5</code> 部分</p>
</blockquote>
<p>这一块也是由于各个框架，使用的 <code>webpack</code> / <code>postcss</code> 版本不同导致的。</p>
<p>不过要达成这个目标还是比较简单的，看看<code>webpack</code>文档就可以了，而 <code>rollup/vite</code> 这种，它们本身的 <code>API</code> 就要比 <code>webpack</code> 简单，实现起来也非常简单。</p>
<p>具体举一些例子便是:</p>
<div class="language-js codeBlockContainer_i86R theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_Es0n"><pre tabindex="0" class="prism-code language-js codeBlock_NCAI thin-scrollbar" style="color:#D4D4D4;background-color:#212121"><code class="codeBlockLines_mn2G"><span class="token-line" style="color:#D4D4D4"><span class="token comment" style="color:rgb(106, 153, 85)">// webpack5 动态插入 loader</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> NormalModule </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#C586C0">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;webpack&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">NormalModule</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">getCompilationHooks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">compilation</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">loader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">pluginName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token parameter" style="color:#9CDCFE">loaderContext</span><span class="token parameter punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token parameter" style="color:#9CDCFE"> module</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// webpack4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">compilation</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">hooks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">normalModuleLoader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">tap</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">pluginName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token parameter" style="color:#9CDCFE">loaderContext</span><span class="token parameter punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token parameter" style="color:#9CDCFE"> module</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// webpack5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">compilation</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">hooks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">processAssets</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// webpack4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">compilation</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">hooks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">optimizeChunkAssets</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// webpack5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">const</span><span class="token plain"> Compilation </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> compiler</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">webpack</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Compilation</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> ConcatSource </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> compiler</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">webpack</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sources</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// webpack4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> ConcatSource</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> Source </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#C586C0">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;webpack-sources&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// 还有 `loader-utils` 的版本问题</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> getOptions </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword" style="color:#C586C0">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;loader-utils&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">// 还有 Compilation 封闭后 assets 对象不可修改问题等等等等</span><br></span></code></pre><div class="buttonGroup_gg5K"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_hISb" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon__IAY"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_I8oK"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这种问题只要愿意多调试，都能解决。</p>
<h3 class="anchor anchorWithStickyNavbar_oBHm" id="css-选择器替换">css 选择器替换<a class="hash-link" aria-label="css 选择器替换的直接链接" title="css 选择器替换的直接链接" href="/weapp-tailwindcss/docs/principle#css-选择器替换">​</a></h3>
<blockquote>
<p>源码 <code>postcss</code> 部分</p>
</blockquote>
<p>这部分是 <code>postcss</code> 的主场，我们知道 <code>postcss</code> 本质上就是一个 <code>css ast</code> 工具。有了 <code>ast</code> 才有了各种各样的转化插件来生成 <code>css</code>。</p>
<p>现在我们使用它的核心目标为：找到所有 <code>tailwindcss</code> 的生成块，对选择器进行转义。</p>
<p>我们先来解决第一个问题: 怎么找？</p>
<h4 class="anchor anchorWithStickyNavbar_oBHm" id="找到tailwindcss节点">找到tailwindcss节点<a class="hash-link" aria-label="找到tailwindcss节点的直接链接" title="找到tailwindcss节点的直接链接" href="/weapp-tailwindcss/docs/principle#找到tailwindcss节点">​</a></h4>
<blockquote>
<p>源码 <code>postcss/mp</code> 部分</p>
</blockquote>
<p>各个框架，它们公共样式文件的路径不同的。比如 <code>uni-app</code> 的路径就是 <code>common/main.wxss</code>，<code>taro</code> 则为 <code>app.wxss</code> ，而某些框架更加的奇葩，<code>common/miniprogram-app.wxss</code> 等等，这简直就是简直了。</p>
<p>所以我们可以通过用户传入的 <code>appType</code> 这个框架类型，以此来精确定位公共样式的位置。不过这个方案后续还经过了许多的优化，核心便是利用 <code>postcss</code> 解析，对 <code>tailwindcss</code> 所在的文件位置，进行猜测。</p>
<p>这个猜测的方案是由于 <code>tailwindcss</code> 的特性实现的。因为 <code>tailwindcss</code> 它在生成原子类之前，它会先去注入大量的 <code>css</code> 变量，以此来控制所 有的原子类的呈现。</p>
<p>所以我们会看到这样一个 <code>css</code> 节点</p>
<div class="language-css codeBlockContainer_i86R theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_Es0n"><pre tabindex="0" class="prism-code language-css codeBlock_NCAI thin-scrollbar" style="color:#D4D4D4;background-color:#212121"><code class="codeBlockLines_mn2G"><span class="token-line" style="color:#D4D4D4"><span class="token selector" style="color:rgb(215, 186, 125)">*,:after,:before</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token property" style="color:#9CDCFE">--tw-border-spacing-x</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> 0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token property" style="color:#9CDCFE">--tw-border-spacing-y</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> 0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token property" style="color:#9CDCFE">--tw-translate-x</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> 0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token property" style="color:#9CDCFE">--tw-translate-y</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> 0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token property" style="color:#9CDCFE">--tw-rotate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> 0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">/* ..... */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup_gg5K"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_hISb" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon__IAY"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_I8oK"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>那么我们就可以认为，找到它，这个文件就是公共样式的所在之处了。不过在寻址时要注意选择器条件和 <code>-tw-</code> 变量条件，以此做到精确匹配。</p>
<h4 class="anchor anchorWithStickyNavbar_oBHm" id="转义原子类选择器">转义原子类选择器<a class="hash-link" aria-label="转义原子类选择器的直接链接" title="转义原子类选择器的直接链接" href="/weapp-tailwindcss/docs/principle#转义原子类选择器">​</a></h4>
<blockquote>
<p>源码 <code>postcss/selectorParser</code> 和 <code>shared</code> 部分</p>
</blockquote>
<p>第一个问题解决了，第二个问题接踵而至，怎么换？</p>
<p>直接对所有的选择器进行转义可行吗？显然是不可行的，这只会导致 <code>css</code> 的大面积误伤。</p>
<p>我们知道一个<code>css</code>选择器，可能很简单也可以很复杂，它可以包含相邻兄弟选择器，子选择器，后代选择器，通用兄弟选择器，伪类选择器，伪元素选择器，还能使用 <code>,</code> 来添加选择器。我们必须要对选择器进一步解析，从而做到精确匹配和转义。</p>
<p>这时候就需要 <code>postcss-selector-parser</code> 出场了。</p>
<p>我们在使用 <code>postcss</code> 进行 <code>root.walk</code> 之后，再把符合条件的 <code>css</code> 节点进行 <code>selectors.walk</code>，从而达成了选择器局部精确转义的效果。</p>
<p>另外由于 <code>tailwindcss</code> 默认的 <code>preflight</code> 是针对 <code>h5</code> 的，所以我们也需要注入自己的小程序 <code>preflight</code>，还有一点值得注意就是， <code>js/wxml</code> 的转义方法和 <code>wxss</code> 的转义方法是不同的，因为 <code>css</code> 中，往往会多加一个 <code>\</code> 字符。</p>
<h3 class="anchor anchorWithStickyNavbar_oBHm" id="模板解析的重新实现">模板解析的重新实现<a class="hash-link" aria-label="模板解析的重新实现的直接链接" title="模板解析的重新实现的直接链接" href="/weapp-tailwindcss/docs/principle#模板解析的重新实现">​</a></h3>
<blockquote>
<p>源码 <code>reg</code> 和 <code>wxml/utils</code> 部分</p>
</blockquote>
<p>原先用的 <code>wxml ast</code> 是第三方的，已经彻底没人维护了，一直出 <code>bug</code>(比如<code>wxml</code>内联<code>wxs</code>)，于是自己基于正则写了一个模板属性提取器。</p>
<p>这是由于日益增长的需求导致的，原先可能想着模板里，只要支持 <code>class</code>/ <code>hover-class</code> 这类的属性转义就够了。但是后续发现，用户在定义和使用组件的时候，也会经常把 <code>className</code> 作为属性传入进组件，这时候就需要我们自定义生成正则，来对满足条件的属性进行转义了。比如:</p>
<div class="language-html codeBlockContainer_i86R theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_Es0n"><pre tabindex="0" class="prism-code language-html codeBlock_NCAI thin-scrollbar" style="color:#D4D4D4;background-color:#212121"><code class="codeBlockLines_mn2G"><span class="token-line" style="color:#D4D4D4"><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:#569CD6">my-com</span><span class="token tag" style="color:#569CD6"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">class</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">bg-[#123456]</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:#569CD6"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">hover-class</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">bg-[#654321]</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:#569CD6"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">custom-class</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">text-[#ff00ff]</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:#569CD6"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">happy-attr</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">text-[green]</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag" style="color:#569CD6"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">sad-attr</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(212, 212, 212)">=</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag attr-value" style="color:rgb(206, 145, 120)">text-[blue]</span><span class="token tag attr-value punctuation" style="color:rgb(212, 212, 212)">&quot;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:#569CD6">my-com</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><br></span></code></pre><div class="buttonGroup_gg5K"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_hISb" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon__IAY"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_I8oK"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>默认只匹配转义 <code>2</code> 个，怎么行呢？所以开放了 <code>customAttributesEntities</code> 配置项，这个配置项会和原先 <code>class</code>/ <code>hover-class</code> 相关的属性一起进行匹配，从而转化上述例子中所有的 <code>Arbitrary values</code>。</p>
<h3 class="anchor anchorWithStickyNavbar_oBHm" id="动态源码补丁">动态源码补丁<a class="hash-link" aria-label="动态源码补丁的直接链接" title="动态源码补丁的直接链接" href="/weapp-tailwindcss/docs/principle#动态源码补丁">​</a></h3>
<blockquote>
<p>源码 <code>tailwindcss</code> 部分</p>
</blockquote>
<p>很多时候，出于 <code>tailwindcss</code> 自身的限制，和技术国情等等原因。我们的 <code>pr</code> 往往不会被他们接受，这时候我们就需要自己去修改他们的源码，从而封装一个符合中国国情的 <code>tailwindcss</code>。这种可以通过 <code>fork</code> 一个新的版本进行发布来做到，也可以通过给源码打补丁做到。</p>
<blockquote>
<p>注意点：给源码打补丁，这个操作一定要是幂等的，不然重复执行可能会破坏源码的结构</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_oBHm" id="支持自定义长度单位rpx">支持自定义长度单位(rpx)<a class="hash-link" aria-label="支持自定义长度单位(rpx)的直接链接" title="支持自定义长度单位(rpx)的直接链接" href="/weapp-tailwindcss/docs/principle#支持自定义长度单位rpx">​</a></h4>
<blockquote>
<p>源码 <code>tailwindcss/supportCustomUnit</code> 部分</p>
</blockquote>
<p>自从 <code>tailwindcss 3.2.x</code> 开始，由于加入了单位分类校验 <a href="https://github.com/sonofmagic/weapp-tailwindcss-webpack-plugin/issues/110" target="_blank" rel="noopener noreferrer">issue#110</a> 导致原先一些直接在类名里写 <code>rpx</code> 的原子类，被错误识别然后被转化成了颜色。</p>
<p>什么意思呢？</p>
<p>比如现在有三个原子类，<code>text-[#123]</code>，<code>text-[30rpx]</code>，<code>text-[30px]</code>，在 <code>3.2.x</code> 之前，前一个是字体颜色，后面两个是字体的大小。在这个版本之后，前 <strong>2</strong> 个是颜色，只有最后一个是字体大小了！</p>
<p>这是因为 <code>tailwindcss</code> 会对 <code>mdn</code> 上合法长度单位进行校验，在合法长度单位列表内，则认为是字体大小，反之则为字体颜色。而 <code>rpx</code> 这个单位是微信的独创，不是一个标准的 <code>css</code> 单位，自然就在合法长度单位这个集合之外了。</p>
<p>那么如何进行修复支持呢？通过阅读 <code>tailwindcss</code> 的源码，会发现它校验单位的方法在 <code>utils/dataType.js</code> 这个文件里。</p>
<p>再通过 <code>babel</code> 三件套: <code>parse</code>，<code>traverse</code>,<code>generate</code> 可以精确锁定暴露的合法变量列表位置，然后把 <code>rpx</code> 这个单位 <code>push</code> 进 <code>ast node.elements</code>之后，重新生成覆写即可。</p>
<h2 class="anchor anchorWithStickyNavbar_oBHm" id="20-增加了什么">2.0 增加了什么？<a class="hash-link" aria-label="2.0 增加了什么？的直接链接" title="2.0 增加了什么？的直接链接" href="/weapp-tailwindcss/docs/principle#20-增加了什么">​</a></h2>
<p>这个版本新增了 <code>UnifiedWebpackPluginV5</code>
和 <code>UnifiedViteWeappTailwindcssPlugin</code> 这种以 <code>Unified</code> 开头的插件。</p>
<p>它们能够自动识别并精确处理所有 <code>tailwindcss</code> 的工具类，这意味着它可以同时处理 <code>wxss</code>,<code>wxml</code> 和 <code>js</code> 里静态和动态的 <code>class</code>(v1版本只有处理<code>wxss</code>,<code>wxml</code>静态<code>class</code>的能力)。所以你再也不需要在 <code>js</code> 里引入并调用 <code>replaceJs</code>方法了！由于 <code>2.x</code> 插件有精准转化 <code>js</code>/<code>jsx</code> 的能力，误伤问题得到了有效的解决，也大大提升了 <code>taro</code> 这种动态模板框架的开发体验。</p>
<p>欢迎体验，<code>star</code>/<code>fork</code>。</p>
<h2 class="anchor anchorWithStickyNavbar_oBHm" id="尾言">尾言<a class="hash-link" aria-label="尾言的直接链接" title="尾言的直接链接" href="/weapp-tailwindcss/docs/principle#尾言">​</a></h2>
<p>正如马克·吐温的名言： <code>To a man with a hammer, everything looks like a nail</code>。</p>
<p>笔者的方案肯定也会有许多的局限性，本篇文章也不可避免的会出现许多的勘误。</p>
<p>欢迎大佬们指出，也欢迎大家的建议和指点 ^_^</p>
<p>作者: <a href="https://github.com/sonofmagic" target="_blank" rel="noopener noreferrer">ice breaker</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/sonofmagic/weapp-tailwindcss/tree/main/website/docs/principle/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_tb22" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JLYJ"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/weapp-tailwindcss/docs/quick-start/intelliSense"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">IDE 智能提示设置</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/weapp-tailwindcss/docs/how-to-contribute"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">如何贡献</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_oakM thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#2024-02-20-版本">2024-02-20 版本</a></li><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#前言">前言</a></li><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#什么是-weapp-tailwindcss">什么是 weapp-tailwindcss</a></li><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#为什么需要-weapp-tailwindcss-">为什么需要 weapp-tailwindcss ？</a></li><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#核心原理">核心原理</a></li><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#wxml"><code>wxml</code></a><ul><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#为什么是-htmlparser2">为什么是 <code>htmlparser2</code></a></li><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#如何使用-htmlparser2">如何使用 <code>htmlparser2</code></a></li><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#字符串以及变量绑定的处理">字符串以及变量绑定的处理</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#js--wxs">js / wxs</a></li><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#wxss">wxss</a><ul><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#postcss-对象简单介绍">postcss 对象简单介绍</a></li><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#tailwindcss-简单原理和运行表现">Tailwindcss 简单原理和运行表现</a></li><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#开始转化">开始转化</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#大功告成">大功告成</a></li><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#2023-03-19-版本">2023-03-19 版本</a></li><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#前言-1">前言</a></li><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#这个插件是做什么的">这个插件是做什么的？</a></li><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#原理篇">原理篇</a><ul><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#utility-first-css-framework">utility-first CSS framework</a></li><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#小程序兼容">小程序兼容</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#笔者的实现">笔者的实现</a><ul><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#js里的字面量转义很容易误伤">js里的字面量转义很容易误伤</a></li><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#多框架兼容">多框架兼容</a></li><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#css-选择器替换">css 选择器替换</a></li><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#模板解析的重新实现">模板解析  的重新实现</a></li><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#动态源码补丁">动态源码补丁</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#20-增加了什么">2.0 增加了什么？</a></li><li><a class="table-of-contents__link toc-highlight" href="/weapp-tailwindcss/docs/principle#尾言">尾言</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/weapp-tailwindcss/docs/intro">指南</a></li><li class="footer__item"><a class="footer__link-item" href="/weapp-tailwindcss/docs/options">配置项</a></li><li class="footer__item"><a class="footer__link-item" href="/weapp-tailwindcss/docs/issues">常见问题</a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/sonofmagic/weapp-tailwindcss" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_btZh"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://icebreaker.top" target="_blank" rel="noopener noreferrer" class="footer__link-item">博客<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_btZh"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://ui.icebreaker.top/zh-CN" target="_blank" rel="noopener noreferrer" class="footer__link-item">IceStack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_btZh"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/sonofmagic/weapp-pandacss" target="_blank" rel="noopener noreferrer" class="footer__link-item">weapp-pandacss<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_btZh"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><div class="flex flex-col items-center md:items-start md:flex-row justify-center md:space-x-2">
        <span>Copyright © 2024 icebreaker</span> <a target="_blank" rel="nofollow" href="http://beian.miit.gov.cn">苏ICP备19002675号-2</a> <span class="flex items-center space-x-1"><img src="/img/beian.png" class="h-4"> <a target="_blank" rel="noreferrer" href="https://beian.mps.gov.cn/#/query/webSearch?code=32050602011962">苏公网安备32050602011962</a></span></div></div></div></div></footer></div>
</body>
</html>