# 预设分发

<cite>
**本文档引用的文件**  
- [package.json](file://packages/weapp-tailwindcss/package.json)
- [tsup.config.ts](file://packages/weapp-tailwindcss/tsup.config.ts)
- [index.css](file://packages/weapp-tailwindcss/index.css)
- [preflight.css](file://packages/weapp-tailwindcss/preflight.css)
- [theme.css](file://packages/weapp-tailwindcss/theme.css)
- [utilities.css](file://packages/weapp-tailwindcss/utilities.css)
- [with-layer.css](file://packages/weapp-tailwindcss/with-layer.css)
- [tailwindcss-config/package.json](file://packages/tailwindcss-config/package.json)
- [tailwindcss-config/src/index.ts](file://packages/tailwindcss-config/src/index.ts)
- [weapp-style-injector/package.json](file://packages/weapp-style-injector/package.json)
</cite>

## 目录
1. [简介](#简介)
2. [预设打包格式](#预设打包格式)
3. [发布流程](#发布流程)
4. [依赖管理与版本兼容性](#依赖管理与版本兼容性)
5. [安全最佳实践](#安全最佳实践)
6. [企业级工作流](#企业级工作流)
7. [总结](#总结)

## 简介
weapp-tailwindcss 是一个为小程序开发者提供 Tailwind CSS 原子化样式能力的工具库。该文档详细介绍了如何打包、发布和共享其预设配置，涵盖从开发到部署的完整流程。

**本节不分析具体源文件，因此无需添加源引用**

## 预设打包格式
weapp-tailwindcss 预设的打包格式遵循模块化设计原则，通过 `tsup` 工具进行构建。其核心配置位于 `tsup.config.ts` 文件中，定义了多个入口点，包括 `index`、`webpack`、`vite`、`gulp` 等，以支持不同构建工具的集成。

预设的核心样式文件包括：
- `index.css`：主样式文件，包含主题变量和 `@tailwind utilities` 指令。
- `preflight.css`：重置样式，确保跨平台一致性。
- `theme.css`：定义了完整的主题变量，如颜色、间距、字体等。
- `utilities.css`：仅包含 `@tailwind utilities` 指令。
- `with-layer.css`：将主题和基础样式包裹在 `@layer` 指令中，提供更精细的样式控制。

这些 CSS 文件通过 `package.json` 中的 `exports` 字段对外暴露，允许用户按需导入。

**预设打包格式**
- [tsup.config.ts](file://packages/weapp-tailwindcss/tsup.config.ts#L1-L73)
- [package.json](file://packages/weapp-tailwindcss/package.json#L42-L128)

## 发布流程
weapp-tailwindcss 的发布流程通过 `package.json` 中的脚本命令自动化完成。主要流程如下：

1. **构建**：执行 `pnpm run build` 命令，该命令会调用 `tsup` 进行编译，并生成 `dist` 目录下的输出文件。
2. **测试**：运行 `pnpm run test` 执行单元测试，确保代码质量。
3. **版本发布**：使用 `changeset` 工具管理版本变更和发布。`package.json` 中的 `release` 脚本会启动 `changeset` 流程，自动生成版本号并发布到 npm 仓库。

对于公共预设，通过配置 `publishConfig.access` 为 `public` 来发布到公共 npm 仓库。对于私有预设，可以在私有仓库中配置相应的 `registry` 地址进行分发。

**发布流程**
- [package.json](file://packages/weapp-tailwindcss/package.json#L162-L179)
- [package.json](file://packages/weapp-tailwindcss/package.json#L184-L187)

## 依赖管理与版本兼容性
weapp-tailwindcss 通过 `package.json` 精确管理其依赖项。核心依赖包括 `tailwindcss`、`@babel/parser`、`@vue/compiler-dom` 等。项目采用 `pnpm` 作为包管理器，并通过 `pnpm-workspace.yaml` 文件管理 monorepo 内部的包依赖。

为了确保版本兼容性，项目使用了 `catalog` 别名（如 `catalog:tailwindcss3`、`catalog:postcss85`）来锁定特定版本的依赖，避免因依赖版本不一致导致的问题。同时，`devDependencies` 中也包含了大量开发工具和测试框架的依赖。

**依赖管理与版本兼容性**
- [package.json](file://packages/weapp-tailwindcss/package.json#L188-L212)
- [package.json](file://package.json#L114-L270)

## 安全最佳实践
weapp-tailwindcss 在安全方面采取了多项措施：

1. **代码审计**：项目包含完整的测试套件（`vitest`），并通过 `test:dev` 和 `test:ui` 脚本支持开发和 UI 测试。
2. **依赖检查**：使用 `npm-registry-fetch` 和 `local-pkg` 等工具确保依赖的安全性和可追溯性。
3. **版本锁定**：通过 `pnpm-lock.yaml` 文件锁定所有依赖的精确版本，防止恶意依赖注入。
4. **构建安全**：`tsup.config.ts` 中的 `shims: true` 和 `cjsInterop: true` 配置确保了构建输出的兼容性和安全性。

此外，项目还通过 `husky` 集成了 Git 钩子，确保代码提交前经过 linting 和格式化检查。

**安全最佳实践**
- [package.json](file://packages/weapp-tailwindcss/package.json#L168-L170)
- [package.json](file://package.json#L205)
- [tsup.config.ts](file://packages/weapp-tailwindcss/tsup.config.ts#L39-L40)

## 企业级工作流
weapp-tailwindcss 的企业级工作流从开发到部署的全过程如下：

1. **开发**：在 monorepo 结构下，使用 `pnpm` 管理多个包的依赖和链接。
2. **构建**：通过 `turbo` 工具并行执行构建任务，提高构建效率。
3. **测试**：运行完整的测试套件，包括单元测试、集成测试和端到端测试。
4. **发布**：使用 `changeset` 管理版本变更，自动化发布流程。
5. **分发**：通过 npm 公共仓库或私有仓库分发预设，供不同项目使用。

此工作流确保了预设的高质量、高兼容性和高安全性。

**企业级工作流**
- [package.json](file://package.json#L48-L55)
- [package.json](file://package.json#L86-L92)

## 总结
weapp-tailwindcss 提供了一套完整的预设分发解决方案，从打包格式、发布流程、依赖管理到安全最佳实践，都经过了精心设计。通过遵循本文档的指南，开发者可以高效地打包、发布和共享预设配置，提升小程序开发的效率和一致性。

**本节为总结性内容，不分析具体源文件，因此无需添加源引用**