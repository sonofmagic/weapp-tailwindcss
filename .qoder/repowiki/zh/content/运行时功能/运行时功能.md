# 运行时功能

<cite>
**本文档中引用的文件**  
- [cva/src/index.ts](file://packages-runtime/cva/src/index.ts)
- [merge/src/index.ts](file://packages-runtime/merge/src/index.ts)
- [merge-v3/src/index.ts](file://packages-runtime/merge-v3/src/index.ts)
- [variants/src/index.ts](file://packages-runtime/variants/src/index.ts)
- [variants-v3/src/index.ts](file://packages-runtime/variants-v3/src/index.ts)
- [theme-transition/src/index.ts](file://packages-runtime/theme-transition/src/index.ts)
- [runtime/src/index.ts](file://packages-runtime/runtime/src/index.ts)
- [runtime/src/create-runtime.ts](file://packages-runtime/runtime/src/create-runtime.ts)
- [runtime/src/rpx-length.ts](file://packages-runtime/runtime/src/rpx-length.ts)
- [runtime/src/transformers.ts](file://packages-runtime/runtime/src/transformers.ts)
- [ui/src/preset.ts](file://packages-runtime/ui/src/preset.ts)
- [ui/src/variants.ts](file://packages-runtime/ui/src/variants.ts)
- [typography/src/index.js](file://packages-runtime/typography/src/index.js)
- [typography/src/styles.js](file://packages-runtime/typography/src/styles.js)
- [typography/src/transform.ts](file://packages-runtime/typography/src/transform.ts)
</cite>

## 目录
1. [简介](#简介)
2. [CVA函数详解](#cva函数详解)
3. [合并工具：merge与merge-v3](#合并工具merge与merge-v3)
4. [变体系统：variants](#变体系统variants)
5. [UI包集成](#ui包集成)
6. [排版系统：typography](#排版系统typography)
7. [主题切换：theme-transition](#主题切换theme-transition)
8. [核心运行时机制](#核心运行时机制)
9. [最佳实践](#最佳实践)

## 简介
`weapp-tailwindcss` 提供了一套完整的运行时实用工具，用于在小程序环境中高效使用 Tailwind CSS。本文档详细介绍了核心运行时功能，包括条件变体分析（CVA）、类名安全合并、组件变体定义、UI 设计系统集成、响应式排版和主题切换等功能。

**Section sources**
- [cva/src/index.ts](file://packages-runtime/cva/src/index.ts)
- [merge/src/index.ts](file://packages-runtime/merge/src/index.ts)
- [variants/src/index.ts](file://packages-runtime/variants/src/index.ts)

## CVA函数详解

`cva`（Conditional Variant Analysis）函数是创建可变体 UI 组件的核心工具。它基于 `class-variance-authority` 构建，并增加了运行时优化功能。

### TypeScript类型定义
```typescript
function cva<T>(
  base?: ClassValue, 
  config?: Config<T>
): (props?: Props<T>) => string
```

### 功能特性
- **缓存机制**：内置 LRU 缓存（限制 256 项），避免重复计算
- **转义处理**：自动处理小程序环境中的特殊字符转义
- **类型安全**：提供完整的 TypeScript 类型支持

### 使用示例
```typescript
const button = cva(
  'base-class', 
  {
    variants: {
      intent: {
        primary: 'bg-blue-500 text-white',
        secondary: 'bg-gray-500 text-white'
      },
      size: {
        sm: 'text-sm',
        lg: 'text-lg'
      }
    },
    defaultVariants: {
      intent: 'primary',
      size: 'sm'
    }
  }
)

// 使用
button({ intent: 'primary', size: 'lg' })
```

### 最佳实践
- 为常用组件创建预定义的 `cva` 实例
- 利用 `create` 函数自定义运行时选项
- 避免在渲染函数内部创建 `cva` 实例

**Section sources**
- [cva/src/index.ts](file://packages-runtime/cva/src/index.ts)

## 合并工具：merge与merge-v3

`merge` 和 `merge-v3` 工具用于安全地合并 Tailwind CSS 类名，解决类名冲突问题。

### 核心功能
- **智能合并**：基于 `tailwind-merge` 库，自动处理冲突的类名
- **rpx 支持**：特殊处理小程序中的 rpx 单位
- **版本兼容**：提供 v2 和 v3 两个版本以适应不同需求

### TypeScript类型定义
```typescript
interface MergeRuntime {
  twMerge: (...classes: ClassValue[]) => string
  twJoin: (...classes: ClassValue[]) => string
  extendTailwindMerge: (config: Config) => typeof twMerge
  createTailwindMerge: (config: Config) => typeof twMerge
}
```

### 使用示例
```typescript
import { twMerge } from '@weapp-tailwindcss/merge'

// 安全合并类名
const className = twMerge(
  'bg-red-500 hover:bg-blue-500',
  'bg-green-500' // 会被正确覆盖
)

// 自定义配置
const customMerge = extendTailwindMerge({
  theme: {
    opacity: ['disabled']
  }
})
```

### merge与merge-v3的区别
- **merge**：使用 tailwind-merge v3，版本标识为 2
- **merge-v3**：使用 tailwind-merge v3，版本标识为 3
- 两者功能相同，版本号差异用于兼容性处理

### 最佳实践
- 在组件的根元素上使用 `twMerge`
- 避免过度使用嵌套的类名合并
- 对于静态类名，优先使用 `twJoin`

**Section sources**
- [merge/src/index.ts](file://packages-runtime/merge/src/index.ts)
- [merge-v3/src/index.ts](file://packages-runtime/merge-v3/src/index.ts)
- [runtime/src/create-runtime.ts](file://packages-runtime/runtime/src/create-runtime.ts)

## 变体系统：variants

`variants` 系统基于 `tailwind-variants` 构建，提供了强大的组件变体定义和使用能力。

### 核心API
- `tv`：创建变体组件
- `cn`：条件类名合并
- `createTV`：创建自定义变体工厂

### TypeScript类型定义
```typescript
function tv<T>(
  options: TVOptions<T>,
  config?: TVConfig
): (props?: T) => string
```

### 使用示例
```typescript
import { tv } from '@weapp-tailwindcss/variants'

const button = tv({
  base: 'font-semibold rounded-full',
  variants: {
    color: {
      neutral: 'bg-neutral-500 text-white',
      accent: 'bg-accent-500 text-white'
    },
    size: {
      sm: 'px-2 py-1 text-sm',
      md: 'px-4 py-2 text-base'
    }
  },
  compoundVariants: [
    {
      color: 'neutral', 
      size: 'sm',
      class: 'opacity-80'
    }
  ],
  defaultVariants: {
    color: 'neutral',
    size: 'md'
  }
})

// 使用
button({ color: 'accent', size: 'sm' })
```

### 高级功能
- **复合变体**：`compoundVariants` 支持多个条件的组合
- **插槽支持**：支持组件插槽的变体定义
- **配置继承**：支持变体配置的合并与扩展

### 最佳实践
- 为设计系统中的每个组件创建标准化的变体定义
- 使用 `createTV` 创建项目特定的变体工厂
- 合理使用 `compoundVariants` 避免过度复杂化

**Section sources**
- [variants/src/index.ts](file://packages-runtime/variants/src/index.ts)
- [variants-v3/src/index.ts](file://packages-runtime/variants-v3/src/index.ts)

## UI包集成

`ui` 包提供了与 Shadcn UI 等设计系统的集成能力。

### 核心功能
- **预设配置**：提供与主流 UI 库兼容的 Tailwind 配置
- **变体预设**：包含常用组件的预定义变体
- **样式重置**：确保与不同 UI 库的样式兼容性

### TypeScript类型定义
```typescript
interface UIPreset {
  theme: ThemeConfig
  variants: Record<string, TV>
  components: Record<string, ComponentConfig>
}
```

### 使用示例
```typescript
import { createPreset } from '@weapp-tailwindcss/ui'

// 创建与 Shadcn UI 兼容的预设
const shadcnPreset = createPreset({
  theme: {
    extend: {
      colors: {
        border: 'hsl(var(--border))',
        input: 'hsl(var(--input))'
      }
    }
  }
})

// 在 tailwind.config.ts 中使用
export default {
  presets: [shadcnPreset],
  // 其他配置
}
```

### 集成步骤
1. 安装对应的 UI 库
2. 导入 `@weapp-tailwindcss/ui` 的预设
3. 在 Tailwind 配置中添加预设
4. 使用预定义的变体和组件

### 最佳实践
- 根据项目需求选择合适的 UI 集成方案
- 自定义预设以匹配品牌设计系统
- 定期更新预设以保持与 UI 库的兼容性

**Section sources**
- [ui/src/preset.ts](file://packages-runtime/ui/src/preset.ts)
- [ui/src/variants.ts](file://packages-runtime/ui/src/variants.ts)

## 排版系统：typography

`typography` 包提供了创建响应式排版的完整解决方案。

### 核心功能
- **响应式文本**：支持不同屏幕尺寸的文本样式
- **字体堆栈**：优化的字体加载和回退机制
- **排版比例**：基于黄金比例的排版系统

### TypeScript类型定义
```typescript
interface TypographyConfig {
  baseSize: string
  scale: number
  lineHeight: number
  responsive: boolean
}
```

### 使用示例
```typescript
import { typography } from '@weapp-tailwindcss/typography'

// 创建排版实例
const textStyles = typography({
  baseSize: '16px',
  scale: 1.25,
  lineHeight: 1.5
})

// 生成类名
const headingClass = textStyles.h1 // 'text-4xl font-bold leading-tight'
const bodyClass = textStyles.body // 'text-base leading-relaxed'
```

### 配置选项
- `baseSize`：基础字体大小
- `scale`：字体缩放比例
- `lineHeight`：行高系数
- `responsive`：是否启用响应式

### 最佳实践
- 在项目开始时定义统一的排版系统
- 使用语义化的类名而非具体的字体大小
- 考虑可访问性，确保足够的对比度和可读性

**Section sources**
- [typography/src/index.js](file://packages-runtime/typography/src/index.js)
- [typography/src/styles.js](file://packages-runtime/typography/src/styles.js)
- [typography/src/transform.ts](file://packages-runtime/typography/src/transform.ts)

## 主题切换：theme-transition

`theme-transition` 工具实现了平滑的主题切换动画。

### 核心功能
- **视图过渡**：利用 CSS View Transitions API
- **渐变动画**：圆形展开/收缩的视觉效果
- **降级处理**：不支持的环境自动降级

### TypeScript类型定义
```typescript
interface UseToggleThemeOptions {
  toggle: () => void | Promise<void>
  isCurrentDark: () => boolean
  viewTransition: {
    before: () => void | Promise<void>
    after: () => void | Promise<void>
  }
  duration: number
  easing: string
}

interface UseToggleThemeResult {
  toggleTheme: (event?: Event) => Promise<void>
  isAppearanceTransition: boolean
  capabilities: ToggleThemeCapabilities
}
```

### 使用示例
```typescript
import { useToggleTheme } from '@weapp-tailwindcss/theme-transition'

const { toggleTheme, isAppearanceTransition } = useToggleTheme({
  toggle: () => {
    // 切换主题逻辑
    document.documentElement.classList.toggle('dark')
  },
  isCurrentDark: () => document.documentElement.classList.contains('dark'),
  duration: 400,
  easing: 'ease-in-out'
})

// 绑定到按钮
button.addEventListener('click', toggleTheme)
```

### 动画流程
1. 捕获当前视图状态
2. 执行主题切换
3. 创建圆形裁剪动画
4. 平滑过渡到新主题

### 最佳实践
- 提供主题切换的视觉反馈
- 考虑用户偏好（`prefers-reduced-motion`）
- 在不支持的环境中提供优雅降级

**Section sources**
- [theme-transition/src/index.ts](file://packages-runtime/theme-transition/src/index.ts)

## 核心运行时机制

### 转义与反转义
运行时系统提供了完整的类名转义机制，确保小程序环境中的兼容性。

```typescript
function resolveTransformers(options?: CreateOptions): Transformers {
  return {
    escape: (value) => escapeSelectors(value, options),
    unescape: (value) => unescapeSelectors(value, options)
  }
}
```

### RPX 单位处理
特殊处理小程序中的 rpx 单位，确保样式正确应用。

```typescript
function createRpxLengthTransform(prefixes = ['text', 'border', 'bg']) {
  // 处理类似 text-[16rpx] 的任意值
  return { prepareValue, restoreValue }
}
```

### 缓存策略
所有运行时工具都实现了 LRU 缓存，提高性能。

```typescript
const CACHE_LIMIT = 256
const cache = new Map<string, string>()
```

**Section sources**
- [runtime/src/index.ts](file://packages-runtime/runtime/src/index.ts)
- [runtime/src/transformers.ts](file://packages-runtime/runtime/src/transformers.ts)
- [runtime/src/rpx-length.ts](file://packages-runtime/runtime/src/rpx-length.ts)

## 最佳实践

### 性能优化
- **预创建实例**：在模块级别创建 `cva` 和 `tv` 实例
- **合理使用缓存**：理解缓存机制，避免不必要的重复计算
- **减少运行时开销**：静态类名优先于动态生成

### 类名组织
- **语义化命名**：使用有意义的变体名称
- **层次化结构**：建立组件-变体-状态的层次结构
- **一致性**：在整个项目中保持命名约定一致

### 类型安全
- **充分利用 TypeScript**：利用完整的类型推断
- **自定义类型**：为复杂变体创建专门的类型定义
- **类型检查**：在 CI/CD 中包含类型检查

### 可维护性
- **文档化变体**：为每个组件的变体编写文档
- **设计系统集成**：与设计系统保持同步
- **定期审查**：定期审查和优化类名使用

**Section sources**
- [cva/src/index.ts](file://packages-runtime/cva/src/index.ts)
- [merge/src/index.ts](file://packages-runtime/merge/src/index.ts)
- [variants/src/index.ts](file://packages-runtime/variants/src/index.ts)
- [theme-transition/src/index.ts](file://packages-runtime/theme-transition/src/index.ts)