# 排版系统

<cite>
**本文档引用的文件**   
- [index.js](file://packages-runtime/typography/src/index.js)
- [transform.ts](file://packages-runtime/typography/src/transform.ts)
- [styles.js](file://packages-runtime/typography/src/styles.js)
- [utils.js](file://packages-runtime/typography/src/utils.js)
- [tailwind.config.ts](file://website/tailwind.config.ts)
</cite>

## 目录
1. [简介](#简介)
2. [核心功能](#核心功能)
3. [配置与转换](#配置与转换)
4. [使用示例](#使用示例)
5. [可访问性与性能](#可访问性与性能)
6. [结论](#结论)

## 简介
`typography` 包是一个为小程序适配的 Tailwind CSS 排版插件，旨在为不受控制的 HTML 内容（如 Markdown 渲染内容或从 CMS 获取的内容）提供美观的排版默认样式。该插件通过 `prose` 类为文本内容提供语义化和响应式的样式支持，确保在不同设备和主题下都能保持一致的视觉体验。

**Section sources**
- [README.md](file://packages-runtime/typography/README.md)

## 核心功能

### 字体堆栈管理
`typography` 插件通过预定义的字体堆栈确保文本在不同平台和设备上的一致性。默认使用 `Inter var` 作为无衬线字体，`Fira Code VF` 作为等宽字体，这些字体在现代浏览器中具有良好的渲染效果。

### 行高与字间距控制
插件通过精细化的行高（line-height）和字间距（letter-spacing）设置，优化文本的可读性。例如，`h1`、`h2`、`h3` 标题的字间距设置为 `-0.025em`，以增强标题的紧凑感和视觉吸引力。

### 响应式断点支持
`typography` 插件支持多种响应式断点，包括 `sm`、`base`、`lg`、`xl` 和 `2xl`。每个断点都有对应的字体大小、行高和间距设置，确保文本在不同屏幕尺寸下都能保持良好的可读性。

### 颜色主题
插件提供了多种颜色主题，如 `slate`、`gray`、`zinc`、`neutral` 和 `stone`，以及针对深色模式的 `invert` 主题。这些主题通过 CSS 自定义属性（如 `--tw-prose-body`、`--tw-prose-headings`）定义，允许开发者轻松切换和自定义颜色方案。

**Section sources**
- [styles.js](file://packages-runtime/typography/src/styles.js#L22-L1400)

## 配置与转换

### transform 函数
`transform` 函数是 `typography` 插件的核心，负责将高级排版配置转换为具体的 CSS 样式规则。该函数使用 `htmlparser2` 解析 HTML 内容，并通过 `magic-string` 进行字符串操作，为每个 HTML 元素添加相应的类名。

```typescript
import { Parser } from 'htmlparser2'
import MagicString from 'magic-string'

export default (html: string, options?: Partial<{ prefix: string }>) => {
  const { prefix = '' } = options ?? {}
  const s = new MagicString(html)
  let tagName: string | undefined

  const hasClassStack: boolean[] = []
  const stack: number[] = []
  const parser = new Parser({
    onopentagname(name) {
      tagName = name
      stack.push(parser.endIndex)
    },
    onattribute(name) {
      if (name === 'class' && tagName) {
        s.appendLeft(parser.startIndex + 7, `${prefix + tagName} `)
      }
    },
    onopentag(_name, attribs) {
      hasClassStack.push('class' in attribs)
    },
    onclosetag(name) {
      const p = stack.pop()
      if (!hasClassStack.pop() && typeof p === 'number') {
        s.appendRight(p, ` class="${prefix + name}"`)
      }
      tagName = undefined
    },
  })

  parser.write(s.original)
  parser.end()
  return s.toString()
}
```

**Section sources**
- [transform.ts](file://packages-runtime/typography/src/transform.ts#L1-L38)

### configToCss 函数
`configToCss` 函数负责将排版配置转换为 CSS 样式规则。该函数通过递归遍历配置对象，生成相应的 CSS 规则，并处理嵌套选择器和伪类。

```javascript
function configToCss(config = {}, { target, className, modifier, prefix, mode, classPrefix }) {
  function updateSelector(k, v) {
    if (target === 'legacy') {
      return mode === 'class' && typeof v === 'object' ? [transformTag2Class(k, classPrefix), v] : [k, v]
    }

    if (Array.isArray(v)) {
      return [k, v]
    }

    if (isObject(v)) {
      const nested = Object.values(v).some(element => isObject(element))
      if (nested) {
        return [inWhere(k, { className, modifier, prefix }), v, Object.fromEntries(Object.entries(v).map(([k, v]) => updateSelector(k, v)))]
      }

      return [inWhere(k, { className, modifier, prefix }), v]
    }

    return [k, v]
  }

  return Object.fromEntries(
    Object.entries(
      merge(
        {},
        ...Object.keys(config)
          .filter(key => computed[key])
          .map(key => computed[key](config[key])),
        ...castArray(config.css || {}),
      ),
    ).map(([k, v]) => updateSelector(k, v)),
  )
}
```

**Section sources**
- [index.js](file://packages-runtime/typography/src/index.js#L45-L80)

## 使用示例

### Markdown 渲染
在 Markdown 渲染中，`typography` 插件可以自动为生成的 HTML 内容添加 `prose` 类，确保文本样式的一致性。

```html
<div class="prose">
  <h1>标题</h1>
  <p>这是一个段落。</p>
  <ul>
    <li>列表项 1</li>
    <li>列表项 2</li>
  </ul>
</div>
```

### 富文本编辑器
在富文本编辑器中，`typography` 插件可以为用户输入的内容提供一致的样式，确保内容在不同设备和主题下都能保持良好的可读性。

```html
<div class="prose prose-lg">
  <h2>子标题</h2>
  <p>这是另一个段落。</p>
  <pre><code class="language-js">const code = '示例代码';</code></pre>
</div>
```

### 内容密集型应用
在内容密集型应用中，`typography` 插件可以通过自定义主题和断点，为大量文本内容提供优化的排版样式。

```html
<div class="prose prose-invert">
  <h1>深色模式标题</h1>
  <p>这是深色模式下的段落。</p>
</div>
```

**Section sources**
- [tailwind.config.ts](file://website/tailwind.config.ts#L36-L251)

## 可访问性与性能

### 可访问性最佳实践
`typography` 插件遵循可访问性最佳实践，确保文本内容在不同设备和辅助技术下都能被正确读取。例如，通过设置适当的对比度和字体大小缩放，确保文本在低视力用户设备上也能清晰可见。

### 性能优化
为了提高性能，`typography` 插件采用了 CSS-in-JS 的样式提取和缓存策略。通过将样式规则提取到单独的 CSS 文件中，并利用浏览器缓存，减少页面加载时间。

**Section sources**
- [styles.js](file://packages-runtime/typography/src/styles.js#L1402-L1634)
- [utils.js](file://packages-runtime/typography/src/utils.js#L8-L67)

## 结论
`typography` 包为小程序提供了强大的排版功能，通过精细化的字体堆栈管理、行高与字间距控制、响应式断点支持和颜色主题，确保文本内容在不同设备和主题下都能保持一致的视觉体验。通过 `transform` 和 `configToCss` 函数，开发者可以轻松地将高级排版配置转换为具体的 CSS 样式规则，并在 Markdown 渲染、富文本编辑器和内容密集型应用中使用。同时，插件遵循可访问性最佳实践，并通过性能优化策略，确保在各种场景下都能提供出色的用户体验。