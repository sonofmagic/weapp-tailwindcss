# 构建工具集成

<cite>
**本文档中引用的文件**  
- [weapp-tailwindcss/package.json](file://packages/weapp-tailwindcss/package.json)
- [demo/gulp-app/gulpfile.ts](file://demo/gulp-app/gulpfile.ts)
- [demo/native-mina/webpack.config.js](file://demo/native-mina/webpack.config.js)
- [apps/vite-native/vite.config.ts](file://apps/vite-native/vite.config.ts)
- [demo/gulp-app/postcss.config.js](file://demo/gulp-app/postcss.config.js)
- [packages/weapp-tailwindcss/src/index.ts](file://packages/weapp-tailwindcss/src/index.ts)
- [packages/weapp-tailwindcss/src/vite.ts](file://packages/weapp-tailwindcss/src/vite.ts)
- [packages/weapp-tailwindcss/src/webpack.ts](file://packages/weapp-tailwindcss/src/webpack.ts)
- [packages/weapp-tailwindcss/src/gulp.ts](file://packages/weapp-tailwindcss/src/gulp.ts)
</cite>

## 目录
1. [简介](#简介)
2. [Webpack 集成指南](#webpack-集成指南)
3. [Vite 集成指南](#vite-集成指南)
4. [Gulp 集成指南](#gulp-集成指南)
5. [Rspack 支持说明](#rspack-支持说明)
6. [通用配置建议](#通用配置建议)
7. [常见问题解决方案](#常见问题解决方案)

## 简介
`weapp-tailwindcss` 是一个为小程序开发者提供 Tailwind CSS 原子化样式能力的工具，支持多种主流构建工具的集成。本文档详细说明如何将 `weapp-tailwindcss` 与 Webpack、Vite、Gulp 等构建工具集成，并提供详细的配置指南、性能优化建议和常见错误解决方案。

**Section sources**
- [packages/weapp-tailwindcss/package.json](file://packages/weapp-tailwindcss/package.json)

## Webpack 集成指南

### 安装步骤
首先通过 npm 或 pnpm 安装必要的依赖包：
```bash
npm install --save-dev weapp-tailwindcss
```

### 配置代码
在 `webpack.config.js` 中注册 `UnifiedWebpackPluginV5` 插件：

```javascript
const { UnifiedWebpackPluginV5 } = require('weapp-tailwindcss/webpack')

module.exports = {
  // ... 其他配置
  plugins: [
    new UnifiedWebpackPluginV5({
      rem2rpx: true,
      onStart() {
        console.log('构建开始')
      },
      onEnd() {
        console.log('构建结束')
      }
    })
  ]
}
```

### 构建脚本示例
```json
{
  "scripts": {
    "build": "webpack --mode production",
    "dev": "webpack --mode development --watch"
  }
}
```

### 性能调优建议
1. 启用缓存机制以加快重复构建速度
2. 合理配置 `splitChunks` 优化代码分割
3. 使用 `mode: 'production'` 启用 Webpack 内置优化

### 常见错误解决方案
- **问题**: 插件未正确加载  
  **解决方案**: 确保使用正确的导入路径 `'weapp-tailwindcss/webpack'`
- **问题**: 样式未转换  
  **解决方案**: 检查 PostCSS 配置是否正确，确保 `tailwindcss` 插件已启用

**Section sources**
- [packages/weapp-tailwindcss/package.json](file://packages/weapp-tailwindcss/package.json#L59-L63)
- [demo/native-mina/webpack.config.js](file://demo/native-mina/webpack.config.js#L8-L98)

## Vite 集成指南

### 安装步骤
```bash
npm install --save-dev weapp-tailwindcss
```

### 配置代码
在 `vite.config.ts` 中使用插件：

```typescript
import { UnifiedViteWeappTailwindcssPlugin as uvwt } from 'weapp-tailwindcss/vite'
import { defineConfig } from 'weapp-vite/config'

export default defineConfig({
  plugins: [
    uvwt({
      rem2rpx: true,
      cssEntries: [
        path.resolve(import.meta.dirname, './app.css')
      ]
    })
  ]
})
```

### 开发服务器和 HMR 配置
Vite 默认支持热模块替换（HMR），无需额外配置。开发服务器可通过以下命令启动：
```bash
vite
```

### 构建脚本示例
```json
{
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  }
}
```

### 性能调优建议
1. 利用 Vite 的原生 ES 模块支持提升开发服务器启动速度
2. 合理配置 `css.preprocessorOptions` 优化预处理器性能
3. 使用 `build.rollupOptions` 进行高级构建优化

### 常见错误解决方案
- **问题**: HMR 不工作  
  **解决方案**: 确保文件路径正确，检查插件加载顺序
- **问题**: 样式热更新延迟  
  **解决方案**: 检查 `cssEntries` 配置是否包含所有需要监控的 CSS 文件

**Section sources**
- [packages/weapp-tailwindcss/package.json](file://packages/weapp-tailwindcss/package.json#L54-L58)
- [apps/vite-native/vite.config.ts](file://apps/vite-native/vite.config.ts#L3-L27)

## Gulp 集成指南

### 安装步骤
```bash
npm install --save-dev weapp-tailwindcss gulp
```

### 配置代码
在 `gulpfile.ts` 中创建并使用插件：

```typescript
import { createPlugins } from 'weapp-tailwindcss/gulp'

const { transformJs, transformWxml, transformWxss } = createPlugins({
  rem2rpx: true
})

function sassCompile() {
  return gulp
    .src(paths.src.scssFiles)
    .pipe(postcss())
    .pipe(transformWxss())
    .pipe(rename({ extname: '.wxss' }))
    .pipe(gulp.dest(paths.dist.baseDir))
}
```

### 构建管道示例
```javascript
const buildTasks = [
  cleanTmp,
  copyBasicFiles,
  sassCompile,
  copyWXML,
  compileTsFiles
]

gulp.task('default', gulp.series(...buildTasks))
```

### 性能调优建议
1. 使用流式处理避免中间文件写入
2. 合理配置文件监听，减少不必要的重建
3. 并行执行独立的任务以提高效率

### 常见错误解决方案
- **问题**: 流处理中断  
  **解决方案**: 确保正确处理流的结束和错误事件
- **问题**: 文件监听不生效  
  **解决方案**: 检查 `gulp.watch` 的路径配置和忽略模式

**Section sources**
- [packages/weapp-tailwindcss/package.json](file://packages/weapp-tailwindcss/package.json#L74-L78)
- [demo/gulp-app/gulpfile.ts](file://demo/gulp-app/gulpfile.ts#L16-L47)

## Rspack 支持说明
`weapp-tailwindcss` 通过其灵活的架构设计，能够支持 Rspack 等新兴构建工具。虽然目前没有专门的 Rspack 插件导出，但可以通过以下方式集成：

1. 利用现有的 Webpack 兼容层
2. 通过 PostCSS 配置直接集成
3. 自定义插件适配器

具体实现需要根据 Rspack 的插件 API 进行适配开发。

**Section sources**
- [packages/weapp-tailwindcss/package.json](file://packages/weapp-tailwindcss/package.json)

## 通用配置建议

### PostCSS 配置
在 `postcss.config.js` 中确保正确配置：

```javascript
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {}
  }
}
```

### 目录结构最佳实践
- 将源代码放在 `src` 目录
- 构建输出到 `dist` 目录
- 配置文件集中管理

### 性能监控
利用插件提供的生命周期钩子进行构建性能监控：

```javascript
onStart() {
  bench.start()
},
onEnd() {
  bench.end()
}
```

**Section sources**
- [demo/gulp-app/postcss.config.js](file://demo/gulp-app/postcss.config.js#L1-L5)

## 常见问题解决方案

### 插件加载失败
**症状**: 构建时报错找不到模块  
**解决方案**: 
1. 检查包是否正确安装
2. 确认导入路径正确（`weapp-tailwindcss/webpack`、`weapp-tailwindcss/vite` 等）

### 样式未生效
**症状**: Tailwind 类名未被处理  
**解决方案**:
1. 检查 `tailwind.config.js` 配置
2. 确保源文件路径被正确扫描
3. 验证 PostCSS 流程是否完整

### 构建性能低下
**症状**: 构建时间过长  
**解决方案**:
1. 启用缓存
2. 优化文件监听范围
3. 使用生产模式构建

**Section sources**
- [packages/weapp-tailwindcss/src/index.ts](file://packages/weapp-tailwindcss/src/index.ts#L1-L5)
- [packages/weapp-tailwindcss/src/webpack.ts](file://packages/weapp-tailwindcss/src/webpack.ts#L1-L3)
- [packages/weapp-tailwindcss/src/vite.ts](file://packages/weapp-tailwindcss/src/vite.ts#L1-L3)
- [packages/weapp-tailwindcss/src/gulp.ts](file://packages/weapp-tailwindcss/src/gulp.ts#L1-L3)